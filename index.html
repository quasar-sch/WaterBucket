<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¬¼í†µ ë¯¸ì…˜: ì •í™•í•œ ë¬¼ì˜ ì–‘ ë§Œë“¤ê¸°</title>
<style>
  :root{
    --bg:#0b1220;
    --panel:#101a2e;
    --panel2:#0f1a33;
    --ink:#e7eefc;
    --muted:#b8c7f3;
    --line:rgba(255,255,255,.12);
    --accent:#6ee7ff;
    --good:#22c55e;
    --warn:#fbbf24;
    --bad:#fb7185;

    /* Jug visuals */
    --cup-stroke: rgba(255,255,255,.22);
    --cup-fill: rgba(255,255,255,.06);
    --cup-shadow: rgba(0,0,0,.22);
    --tick: rgba(255,255,255,.28);
    --tickText: rgba(231,238,252,.75);
    --waterTop: rgba(110,231,255,.85);
    --waterBottom: rgba(110,231,255,.28);
    --waterEdge: rgba(255,255,255,.22);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    background: radial-gradient(1200px 600px at 20% 10%, rgba(110,231,255,.10), transparent 55%),
                radial-gradient(900px 500px at 80% 15%, rgba(34,197,94,.08), transparent 55%),
                radial-gradient(1000px 600px at 50% 95%, rgba(251,113,133,.10), transparent 60%),
                var(--bg);
    color:var(--ink);
    min-height:100vh;
  }
  .wrap{max-width:980px;margin:0 auto;padding:22px}
  .card{
    background: linear-gradient(180deg, rgba(16,26,46,.92), rgba(12,20,40,.92));
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow: 0 18px 40px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .topbar{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-bottom:1px solid var(--line);
  }
  .title{display:flex;flex-direction:column;gap:2px}
  .title h1{margin:0;font-size:18px;letter-spacing:.2px}
  .title p{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    padding:8px 10px;border-radius:999px;
    font-size:12px;color:var(--muted);
  }
  .pill strong{color:var(--ink);font-weight:700}
  .grid{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:14px;
    padding:14px;
  }
  @media (max-width: 860px){
    .grid{grid-template-columns:1fr}
  }

  .panel{
    background: rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
  }
  .panel h2{
    margin:0 0 10px 0;
    font-size:14px;color:var(--muted);
    font-weight:700;
    letter-spacing:.2px;
  }
  .btnrow{display:flex;flex-wrap:wrap;gap:10px}
  button{
    appearance:none;border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:var(--ink);
    padding:10px 12px;border-radius:12px;
    cursor:pointer;
    font-weight:700;
    transition:.15s transform ease, .15s background ease, .15s border-color ease, .15s opacity ease;
  }
  button:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
  button:active{transform: translateY(0px)}
  button.primary{
    border-color: rgba(110,231,255,.35);
    background: rgba(110,231,255,.10);
  }
  button.good{
    border-color: rgba(34,197,94,.35);
    background: rgba(34,197,94,.10);
  }
  button.warn{
    border-color: rgba(251,191,36,.38);
    background: rgba(251,191,36,.10);
  }
  button.bad{
    border-color: rgba(251,113,133,.38);
    background: rgba(251,113,133,.10);
  }
  button.ghost{background: transparent;}
  button:disabled{opacity:.45; cursor:not-allowed;}

  /* Jugs layout */
  .jugs{
    display:flex; gap:12px; justify-content:center; align-items:flex-end;
    padding:10px 6px 6px 6px;
    min-height:320px;
  }
  .jug{
    width:140px; max-width:32vw;
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:16px;
    padding:10px;
    position:relative;
    user-select:none;
    cursor:pointer;
    transition: .15s transform ease, .15s border-color ease, .15s background ease;
  }
  .jug:hover{transform: translateY(-2px); background: rgba(255,255,255,.05)}
  .jug.selected{
    border-color: rgba(110,231,255,.55);
    box-shadow: 0 0 0 3px rgba(110,231,255,.15);
  }
  .jug .cap{
    display:flex; align-items:center; justify-content:space-between;
    font-size:12px; color:var(--muted); margin-bottom:8px;
  }
  .jug .cap strong{color:var(--ink); font-size:12px}

  .jugSvgWrap{
    width:100%;
    height:230px;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    border-radius:12px;
    background: rgba(0,0,0,.10);
    border:1px solid rgba(255,255,255,.08);
    overflow:hidden;
  }

  .amt{
    margin-top:8px;
    display:flex; justify-content:space-between; align-items:center;
    font-size:12px; color:var(--muted);
  }
  .amt strong{color:var(--ink)}
  .hintbox{
    margin-top:10px;
    border:1px dashed rgba(110,231,255,.28);
    background: rgba(110,231,255,.06);
    padding:10px 12px;border-radius:12px;
    color:var(--muted);
    font-size:13px; line-height:1.45;
    min-height:46px;
  }
  .status{
    display:flex;flex-wrap:wrap; gap:8px;
    font-size:12px; color:var(--muted);
  }
  .status .tag{
    border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;
    background: rgba(255,255,255,.03);
  }
  .status .tag strong{color:var(--ink)}
  .banner{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:var(--muted);
    font-size:13px; line-height:1.45;
  }
  .banner.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.08)}
  .banner.bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08)}
  .row{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }

  /* Modal */
  .modalOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center; justify-content:center;
    padding:18px;
    z-index:50;
  }
  .modal{
    width:min(920px, 100%);
    background: linear-gradient(180deg, rgba(16,26,46,.96), rgba(12,20,40,.96));
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow: 0 22px 60px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .modalHeader{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;
  }
  .modalHeader h3{margin:0;font-size:14px}
  .modalBody{padding:14px 16px}
  .modalBody p{margin:0 0 10px 0; color:var(--muted); line-height:1.55; font-size:13px}
  table{
    width:100%;
    border-collapse:collapse;
    overflow:hidden;
    border-radius:14px;
    border:1px solid var(--line);
  }
  th, td{
    padding:10px 10px;
    border-bottom:1px solid var(--line);
    font-size:13px;
    text-align:left;
  }
  th{color:var(--muted); background: rgba(255,255,255,.03)}
  tr:last-child td{border-bottom:none}
  .kpi{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-bottom:12px;
  }
  @media (max-width: 720px){
    .kpi{grid-template-columns:1fr}
  }
  .kpi .box{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:10px 12px;
  }
  .kpi .box .label{font-size:12px;color:var(--muted)}
  .kpi .box .val{font-size:18px;font-weight:900;margin-top:4px}
  .footerRow{
    display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
    padding:12px 16px;
    border-top:1px solid var(--line);
  }
  .tiny{font-size:12px;color:var(--muted);line-height:1.45}
  .start{padding:18px;}
  .modeCard{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:16px;
    padding:14px;
  }
  .modeCard h3{margin:0 0 6px 0;font-size:15px}
  .modeCard p{margin:0;color:var(--muted);font-size:13px;line-height:1.55}
  .modeCard .btnrow{margin-top:12px}
  .divider{height:1px;background:var(--line);margin:14px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- Start Screen -->
    <div id="startScreen">
      <div class="topbar">
        <div class="title">
          <h1>ë¬¼í†µ ë¯¸ì…˜ : ì •í™•í•œ ë¬¼ì˜ ì–‘ì„ ë§Œë“¤ì–´ë¼</h1>
          <p>ë¬¼ì„ ì˜®ê²¨ ëª©í‘œí•œ ì–‘ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</p>
        </div>
        <div class="pill"><strong>ë²„ì „</strong> v1.1 (SVG)</div>
      </div>

      <div class="start">
        <div class="grid" style="padding:0">
          <div class="modeCard">
            <h3>ğŸŸ¢ Normal ëª¨ë“œ</h3>
            <p>
              ë¬¼í†µì„ ì˜®ê²¨ì„œ <strong>ì •í™•í•œ ë¬¼ì˜ ì–‘ì„ ë§Œë“œëŠ” ì—°ìŠµ ëª¨ë“œ</strong>ì…ë‹ˆë‹¤.<br/>
              íŒíŠ¸ê°€ ìˆìœ¼ë©°, <strong>ì ì€ ì´ë™ìœ¼ë¡œ í•´ê²°í• ìˆ˜ë¡ ë†’ì€ ì ìˆ˜(100ì  ë§Œì )</strong>ë¥¼ ì–»ìŠµë‹ˆë‹¤.
            </p>
            <div class="btnrow">
              <button class="primary" id="btnStartNormal">Normal ì‹œì‘í•˜ê¸°</button>
            </div>
            <div class="divider"></div>
            <div class="tiny">
              â€¢ ëª¨ë“  ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
              â€¢ ì´ˆê¸‰ â†’ ì¤‘ê¸‰ â†’ ê³ ê¸‰ ìˆœì„œë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
            </div>
          </div>

          <div class="modeCard">
            <h3>ğŸ”´ Hard ëª¨ë“œ</h3>
            <p>
              ì´ ëª¨ë“œì—ëŠ” <strong>í•´ê²°í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œë„ í¬í•¨</strong>ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br/>
              ëê¹Œì§€ ì‹œë„í•˜ë©´ì„œ <strong>ì´ ë¬¸ì œëŠ” ê°€ëŠ¥í•œì§€, ë¶ˆê°€ëŠ¥í•œì§€ íŒë‹¨</strong>í•´ì•¼ í•©ë‹ˆë‹¤.
            </p>
            <div class="banner warn" style="margin-top:10px">
              âš ï¸ ì–´ë–¤ ë¬¸ì œëŠ” <strong>ì •ë‹µì„ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  íŒë‹¨í•˜ëŠ” ê²ƒì´ ì •ë‹µ</strong>ì…ë‹ˆë‹¤.
            </div>
            <div class="btnrow" style="margin-top:12px">
              <button class="bad" id="btnStartHard">Hard ë„ì „í•˜ê¸°</button>
            </div>
            <div class="divider"></div>
            <div class="tiny">
              â€¢ íŒíŠ¸ëŠ” ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>
              â€¢ ì ìˆ˜ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (íŒë‹¨ ì¤‘ì‹¬)
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="tiny">
          ì´ ê²Œì„ì€ <strong>ì •ë‹µë¿ë§Œ ì•„ë‹ˆë¼ ìƒê°í•˜ëŠ” ê³¼ì •</strong>ì„ ì¤‘ìš”í•˜ê²Œ ë´…ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" style="display:none">
      <div class="topbar">
        <div class="title">
          <h1 id="modeTitle">Normal</h1>
          <p id="stageDesc">ì„¤ëª…</p>
        </div>
        <div class="status">
          <div class="tag">ìŠ¤í…Œì´ì§€ <strong id="stageNo">1</strong></div>
          <div class="tag">ëª©í‘œ <strong id="goalText">4L</strong></div>
          <div class="tag">ì´ë™ <strong id="movesText">0</strong></div>
          <div class="tag">ì‹œê°„ <strong id="timeText">00:00</strong></div>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>ë¬¼í†µ</h2>
          <div class="banner" id="instructionBanner">
            ë¬¼í†µì„ ì„ íƒí•œ ë’¤ ë‹¤ë¥¸ í†µì„ ëˆŒëŸ¬ ë¬¼ì„ ì˜®ê¸°ì„¸ìš”. ë¬¼ì€ í•œ í†µì´ ë¹„ê±°ë‚˜, ë‹¤ë¥¸ í†µì´ ê°€ë“ ì°° ë•Œê¹Œì§€ ì˜®ê²¨ì§‘ë‹ˆë‹¤.
          </div>

          <div class="jugs" id="jugs"></div>

          <div class="row">
            <div class="tiny" id="selectInfo">ì„ íƒ: ì—†ìŒ</div>
            <div class="btnrow">
              <button id="btnReset" class="ghost">ìŠ¤í…Œì´ì§€ ë¦¬ì…‹</button>
              <button id="btnBackToMenu" class="ghost">ë©”ë‰´</button>
            </div>
          </div>

          <div class="banner warn" id="loopBanner" style="display:none;margin-top:10px">
            ì „ì— ë´¤ë˜ ë¬¼ ìƒíƒœê°€ ë‹¤ì‹œ ë‚˜íƒ€ë‚¬ì–´ìš”. ìƒˆë¡œìš´ ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <div class="panel">
          <h2>ì¡°ì‘</h2>
          <div class="btnrow">
            <button id="btnFill" class="primary">ì±„ìš°ê¸°</button>
            <button id="btnEmpty">ë¹„ìš°ê¸°</button>
            <button id="btnDeclareImpossible" class="bad" style="display:none" disabled>ì´ ë¬¸ì œëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  íŒë‹¨í•˜ê¸°</button>
          </div>

          <div id="normalHintArea" style="margin-top:12px; display:none">
            <div class="row">
              <h2 style="margin:0;color:var(--muted);font-size:14px">íŒíŠ¸</h2>
              <button id="btnHint" class="warn">íŒíŠ¸ ë³´ê¸°</button>
            </div>
            <div class="hintbox" id="hintBox">íŒíŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>

          <div id="hardNoteArea" style="margin-top:12px; display:none">
            <div class="banner">
              ì´ ëª¨ë“œì—ëŠ” í’€ ìˆ˜ ì—†ëŠ” ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëê¹Œì§€ ì‹œë„í•˜ë©° íŒë‹¨í•´ ë³´ì„¸ìš”.
            </div>
          </div>

          <div class="divider"></div>
          <div class="tiny">
            â€¢ ì´ë™ì€ <strong>ì±„ìš°ê¸° / ë¹„ìš°ê¸° / ì˜®ê¸°ê¸°</strong> ëª¨ë‘ 1íšŒë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.<br/>
            â€¢ Normalì€ ë‹¨ê³„ê°€ ëë‚  ë•Œ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalHeader">
      <h3 id="modalTitle">ê²°ê³¼</h3>
      <button class="ghost" id="btnCloseModal">ë‹«ê¸°</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="footerRow" id="modalFooter"></div>
  </div>
</div>

<script>
(() => {
  // ---------- Utility ----------
  const $ = (sel) => document.querySelector(sel);
  const el = (tag, cls) => {
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    return n;
  };
  const pad2 = (n) => String(n).padStart(2,'0');
  const msToMMSS = (ms) => {
    const s = Math.max(0, Math.floor(ms/1000));
    const mm = Math.floor(s/60);
    const ss = s%60;
    return `${pad2(mm)}:${pad2(ss)}`;
  };

  // ---------- BFS ----------
  function bfsMinMoves(capacities, goal){
    const n = capacities.length;
    const start = Array(n).fill(0);
    const key = (st) => st.join(',');
    const q = [{st:start, d:0}];
    const seen = new Set([key(start)]);
    const isGoal = (st) => st.some(v => v === goal);
    if (isGoal(start)) return 0;

    while(q.length){
      const {st, d} = q.shift();
      for(let i=0;i<n;i++){
        if(st[i] !== capacities[i]){
          const ns = st.slice(); ns[i] = capacities[i];
          const k = key(ns);
          if(!seen.has(k)){
            if(isGoal(ns)) return d+1;
            seen.add(k); q.push({st:ns,d:d+1});
          }
        }
        if(st[i] !== 0){
          const ns = st.slice(); ns[i] = 0;
          const k = key(ns);
          if(!seen.has(k)){
            if(isGoal(ns)) return d+1;
            seen.add(k); q.push({st:ns,d:d+1});
          }
        }
        if(st[i] !== 0){
          for(let j=0;j<n;j++){
            if(i===j) continue;
            if(st[j] === capacities[j]) continue;
            const amount = Math.min(st[i], capacities[j]-st[j]);
            if(amount<=0) continue;
            const ns = st.slice();
            ns[i] -= amount;
            ns[j] += amount;
            const k = key(ns);
            if(!seen.has(k)){
              if(isGoal(ns)) return d+1;
              seen.add(k); q.push({st:ns,d:d+1});
            }
          }
        }
      }
    }
    return null;
  }

  // ---------- Stages ----------
  const normalStages = [
    {caps:[3,5], goal:4},
    {caps:[2,7], goal:5},
    {caps:[4,7], goal:3},
    {caps:[5,8], goal:6},
    {caps:[6,10], goal:2},
    {caps:[3,8], goal:7},

    {caps:[4,9], goal:1},
    {caps:[5,9], goal:7},
    {caps:[6,11], goal:5},
    {caps:[7,11], goal:6},
    {caps:[3,5,8], goal:4},
    {caps:[3,7,10], goal:6},
    {caps:[4,7,9], goal:5},

    {caps:[5,8,13], goal:6},
    {caps:[3,6,11], goal:8},
    {caps:[3,7,11], goal:5},
    {caps:[4,9,13], goal:10},
    {caps:[5,7,12], goal:6},
    {caps:[3,8,14], goal:11},
    {caps:[3,7,15], goal:9},
  ];

  const hardStages = [
    {caps:[3,5], goal:4},
    {caps:[2,9], goal:7},
    {caps:[5,8], goal:6},
    {caps:[4,7], goal:5},
    {caps:[3,7,11], goal:5},
    {caps:[6,11], goal:1},

    {caps:[6,10], goal:5},
    {caps:[4,8], goal:6},
    {caps:[3,9], goal:4},
    {caps:[5,15], goal:4},
  ];

  const tiers = [
    {name:"ì´ˆê¸‰", from:1, to:6},
    {name:"ì¤‘ê¸‰", from:7, to:13},
    {name:"ê³ ê¸‰", from:14, to:20},
  ];

  const hintLevels = [
    "í•œ ë²ˆì— í•´ê²°í•˜ë ¤ê³  í•˜ì§€ ë§ê³ , ë¨¼ì € â€˜ì¤‘ê°„ ìƒíƒœâ€™ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.",
    "ì‘ì€ í†µì„ â€˜ì¸¡ì • ë„êµ¬â€™ì²˜ëŸ¼ ì¨ ë³´ì„¸ìš”. ê°€ë“ ì±„ìš°ê³  ì˜®ê¸°ë©´ ë‚¨ëŠ” ì–‘ì´ ìƒê¹ë‹ˆë‹¤.",
    "ê°™ì€ í–‰ë™ì„ ë°˜ë³µí•˜ë‹¤ê°€, ì´ì „ê³¼ ë˜‘ê°™ì€ ìƒí™©ì´ ë‹¤ì‹œ ë‚˜ì˜¤ë©´ ë‹¤ë¥¸ ì„ íƒì„ ì‹œë„í•´ ë³´ì„¸ìš”."
  ];

  // ---------- State ----------
  const state = {
    mode: null,
    stages: [],
    idx: 0,
    caps: [],
    goal: 0,
    amounts: [],
    selected: null,
    moves: 0,
    startMs: 0,
    timerId: null,
    loopSet: new Set(),
    loopDetected: false,
    minMoves: null,
    hintUsed: 0,
    records: []
  };

  // ---------- DOM ----------
  const startScreen = $("#startScreen");
  const gameScreen = $("#gameScreen");
  const modeTitle = $("#modeTitle");
  const stageDesc = $("#stageDesc");
  const stageNo = $("#stageNo");
  const goalText = $("#goalText");
  const movesText = $("#movesText");
  const timeText = $("#timeText");
  const jugsEl = $("#jugs");
  const selectInfo = $("#selectInfo");
  const loopBanner = $("#loopBanner");
  const btnDeclareImpossible = $("#btnDeclareImpossible");

  const normalHintArea = $("#normalHintArea");
  const hardNoteArea = $("#hardNoteArea");
  const hintBox = $("#hintBox");
  const btnHint = $("#btnHint");

  const modalOverlay = $("#modalOverlay");
  const modalTitle = $("#modalTitle");
  const modalBody = $("#modalBody");
  const modalFooter = $("#modalFooter");

  // ---------- Modal helpers ----------
  function showModal(title, bodyNode, footerButtons){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalBody.appendChild(bodyNode);
    modalFooter.innerHTML = "";
    footerButtons.forEach(b => modalFooter.appendChild(b));
    modalOverlay.style.display = "flex";
  }
  function closeModal(){ modalOverlay.style.display = "none"; }
  $("#btnCloseModal").addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if(e.target === modalOverlay) closeModal(); });

  function setScreen(which){
    if(which === "start"){
      startScreen.style.display = "";
      gameScreen.style.display = "none";
      stopTimer();
    }else{
      startScreen.style.display = "none";
      gameScreen.style.display = "";
    }
  }

  // ---------- SVG Jug builder ----------
  function buildJugSvg({id, cap, amt, selected}){
    // cup inner area (for clipping)
    const w = 120, h = 210;
    const innerX = 22, innerY = 22, innerW = 76, innerH = 160;
    const waterH = (amt / cap) * innerH;
    const waterY = innerY + (innerH - waterH);

    // ticks: minimal 0 / mid / max
    const tickSideX = innerX + innerW + 6; // right side
    const tick0Y = innerY + innerH;
    const tickMidY = innerY + innerH/2;
    const tickMaxY = innerY;

    // water wave path (very subtle)
    const waveAmp = 2.2;
    const wave = `M ${innerX} ${waterY}
      C ${innerX+innerW*0.25} ${waterY-waveAmp}, ${innerX+innerW*0.45} ${waterY+waveAmp}, ${innerX+innerW*0.60} ${waterY}
      C ${innerX+innerW*0.75} ${waterY-waveAmp}, ${innerX+innerW*0.88} ${waterY+waveAmp}, ${innerX+innerW} ${waterY}
      L ${innerX+innerW} ${innerY+innerH}
      L ${innerX} ${innerY+innerH}
      Z`;

    const selGlow = selected
      ? `<filter id="glow-${id}" x="-50%" y="-50%" width="200%" height="200%">
           <feGaussianBlur stdDeviation="2.4" result="blur"/>
           <feColorMatrix in="blur" type="matrix"
             values="0 0 0 0 0.43
                     0 0 0 0 0.91
                     0 0 0 0 1
                     0 0 0 .35 0" result="blue"/>
           <feMerge><feMergeNode in="blue"/><feMergeNode in="SourceGraphic"/></feMerge>
         </filter>`
      : "";

    return `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" aria-hidden="true">
        <defs>
          ${selGlow}
          <linearGradient id="cupGrad-${id}" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0" stop-color="rgba(255,255,255,.08)"/>
            <stop offset="0.35" stop-color="rgba(255,255,255,.03)"/>
            <stop offset="0.7" stop-color="rgba(255,255,255,.07)"/>
            <stop offset="1" stop-color="rgba(255,255,255,.04)"/>
          </linearGradient>

          <linearGradient id="waterGrad-${id}" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0" stop-color="var(--waterTop)"/>
            <stop offset="1" stop-color="var(--waterBottom)"/>
          </linearGradient>

          <clipPath id="cupClip-${id}">
            <!-- inner cavity -->
            <rect x="${innerX}" y="${innerY}" width="${innerW}" height="${innerH}" rx="10" ry="10"></rect>
          </clipPath>
        </defs>

        <!-- subtle base shadow -->
        <ellipse cx="${w/2}" cy="${h-10}" rx="36" ry="8" fill="rgba(0,0,0,.25)"></ellipse>

        <!-- cup body -->
        <g ${selected ? `filter="url(#glow-${id})"` : ""}>
          <!-- outer cup -->
          <path d="M 18 20
                   Q 18 10 28 10
                   L 92 10
                   Q 102 10 102 20
                   L 106 184
                   Q 106 198 92 198
                   L 28 198
                   Q 14 198 14 184
                   Z"
                fill="url(#cupGrad-${id})"
                stroke="var(--cup-stroke)" stroke-width="1.2" />

          <!-- rim -->
          <path d="M 26 10 L 94 10
                   Q 102 10 102 18
                   L 102 22
                   Q 102 14 94 14
                   L 26 14
                   Q 18 14 18 22
                   L 18 18
                   Q 18 10 26 10 Z"
                fill="rgba(255,255,255,.10)" stroke="rgba(255,255,255,.18)" stroke-width=".6"/>

          <!-- base thickness -->
          <rect x="18" y="186" width="88" height="14" rx="10" fill="rgba(255,255,255,.07)" stroke="rgba(255,255,255,.12)" stroke-width=".6"></rect>

          <!-- inner wall tint -->
          <rect x="${innerX}" y="${innerY}" width="${innerW}" height="${innerH}" rx="10"
                fill="rgba(0,0,0,.18)" stroke="rgba(255,255,255,.10)" stroke-width=".6"></rect>

          <!-- highlight strip -->
          <rect x="28" y="22" width="10" height="164" rx="6" fill="rgba(255,255,255,.07)"></rect>
        </g>

        <!-- water (clipped to inner cavity) -->
        <g clip-path="url(#cupClip-${id})">
          <!-- animated water body -->
          <path d="${wave}" fill="url(#waterGrad-${id})" style="transition: d .25s ease;"></path>
          <!-- water edge highlight -->
          <path d="M ${innerX} ${waterY}
                   C ${innerX+innerW*0.25} ${waterY-waveAmp}, ${innerX+innerW*0.45} ${waterY+waveAmp}, ${innerX+innerW*0.60} ${waterY}
                   C ${innerX+innerW*0.75} ${waterY-waveAmp}, ${innerX+innerW*0.88} ${waterY+waveAmp}, ${innerX+innerW} ${waterY}"
                fill="none" stroke="var(--waterEdge)" stroke-width="1" opacity=".65"></path>
        </g>

        <!-- minimal ticks -->
        <g opacity=".95">
          <line x1="${tickSideX}" y1="${tickMaxY}" x2="${tickSideX+10}" y2="${tickMaxY}" stroke="var(--tick)" stroke-width="1"/>
          <line x1="${tickSideX}" y1="${tickMidY}" x2="${tickSideX+8}" y2="${tickMidY}" stroke="var(--tick)" stroke-width="1"/>
          <line x1="${tickSideX}" y1="${tick0Y}" x2="${tickSideX+10}" y2="${tick0Y}" stroke="var(--tick)" stroke-width="1"/>

          <text x="${tickSideX+12}" y="${tickMaxY+4}" font-size="10" fill="var(--tickText)">${cap}</text>
          <text x="${tickSideX+12}" y="${tickMidY+4}" font-size="10" fill="var(--tickText)">${Math.round(cap/2)}</text>
          <text x="${tickSideX+12}" y="${tick0Y+4}" font-size="10" fill="var(--tickText)">0</text>
        </g>
      </svg>
    `;
  }

  // ---------- UI ----------
  function stopTimer(){
    if(state.timerId){
      clearInterval(state.timerId);
      state.timerId = null;
    }
  }
  function startTimer(){
    stopTimer();
    state.timerId = setInterval(() => {
      const ms = Date.now() - state.startMs;
      timeText.textContent = msToMMSS(ms);
    }, 250);
    timeText.textContent = "00:00";
  }

  function resetStageState(){
    state.amounts = Array(state.caps.length).fill(0);
    state.selected = null;
    state.moves = 0;
    state.hintUsed = 0;
    state.loopSet = new Set();
    state.loopDetected = false;
    loopBanner.style.display = "none";
    btnDeclareImpossible.disabled = true;
    btnDeclareImpossible.style.display = (state.mode === "hard") ? "" : "none";
    state.loopSet.add(state.amounts.join(','));
    hintBox.textContent = "íŒíŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
    btnHint.disabled = false;

    state.startMs = Date.now();
    startTimer();
    render();
  }

  function render(){
    modeTitle.textContent = state.mode === "normal" ? "Normal" : "Hard";
    stageNo.textContent = String(state.idx + 1);
    goalText.textContent = `${state.goal}L`;
    movesText.textContent = String(state.moves);

    if(state.mode === "normal"){
      stageDesc.textContent = "ëª©í‘œí•œ ë¬¼ì˜ ì–‘ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”. ì´ë™ íšŸìˆ˜ë¥¼ ì¤„ì¼ìˆ˜ë¡ ì ìˆ˜ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤.";
      normalHintArea.style.display = "";
      hardNoteArea.style.display = "none";
      btnDeclareImpossible.style.display = "none";
    }else{
      stageDesc.textContent = "ì´ ë¬¸ì œëŠ” ê°€ëŠ¥í•  ìˆ˜ë„, ë¶ˆê°€ëŠ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ëê¹Œì§€ ì‹œë„í•˜ë©° íŒë‹¨í•´ ë³´ì„¸ìš”.";
      normalHintArea.style.display = "none";
      hardNoteArea.style.display = "";
      btnDeclareImpossible.style.display = "";
    }

    selectInfo.textContent = state.selected == null
      ? "ì„ íƒ: ì—†ìŒ"
      : `ì„ íƒ: ${state.selected+1}ë²ˆ í†µ (${state.caps[state.selected]}L)`;

    // loop banner
    if(state.mode === "hard"){
      loopBanner.style.display = state.loopDetected ? "" : "none";
      btnDeclareImpossible.disabled = !state.loopDetected;
    }else{
      loopBanner.style.display = "none";
    }

    // build jugs
    jugsEl.innerHTML = "";
    state.caps.forEach((cap, i) => {
      const jug = el("div", "jug" + (state.selected===i ? " selected" : ""));
      jug.setAttribute("role","button");
      jug.setAttribute("tabindex","0");

      const head = el("div","cap");
      head.innerHTML = `<span>${i+1}ë²ˆ í†µ</span><strong>${cap}L</strong>`;

      const svgWrap = el("div","jugSvgWrap");
      svgWrap.innerHTML = buildJugSvg({
        id: `s${state.idx}_j${i}`,
        cap,
        amt: state.amounts[i],
        selected: state.selected===i
      });

      const amt = el("div","amt");
      amt.innerHTML = `<span>í˜„ì¬</span><strong>${state.amounts[i]}L</strong>`;

      jug.appendChild(head);
      jug.appendChild(svgWrap);
      jug.appendChild(amt);

      jug.addEventListener("click", () => onJugClick(i));
      jug.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " ") { e.preventDefault(); onJugClick(i); }
      });

      jugsEl.appendChild(jug);
    });
  }

  // ---------- Game logic (selection fix included) ----------
  function addMoveAndCheckLoop(){
    state.moves += 1;
    const key = state.amounts.join(',');
    if(state.loopSet.has(key)){
      state.loopDetected = true;
    }else{
      state.loopSet.add(key);
    }
    movesText.textContent = String(state.moves);
    if(state.mode === "hard"){
      loopBanner.style.display = state.loopDetected ? "" : "none";
      btnDeclareImpossible.disabled = !state.loopDetected;
    }
  }

  function onJugClick(i){
    // 1) If nothing selected: select i
    if(state.selected == null){
      state.selected = i;
      render();
      return;
    }

    // 2) If same jug: keep selected (no-op)
    if(state.selected === i){
      render();
      return;
    }

    // 3) If different jug: try to pour; if cannot, just switch selection
    const from = state.selected;
    const to = i;

    const canPour = canPourAmount(from, to) > 0;

    if(canPour){
      pour(from, to); // pour handles move count, loop, win, and selection
    }else{
      // IMPORTANT FIX: even if pour is impossible, selection should move
      state.selected = to;
      render();
    }
  }

  function canPourAmount(from, to){
    const capTo = state.caps[to];
    if(state.amounts[from] <= 0) return 0;
    if(state.amounts[to] >= capTo) return 0;
    return Math.min(state.amounts[from], capTo - state.amounts[to]);
  }

  function fillSelected(){
    if(state.selected == null) return;
    const i = state.selected;
    if(state.amounts[i] === state.caps[i]) return;
    state.amounts[i] = state.caps[i];
    addMoveAndCheckLoop();
    render();
    checkWin();
  }

  function emptySelected(){
    if(state.selected == null) return;
    const i = state.selected;
    if(state.amounts[i] === 0) return;
    state.amounts[i] = 0;
    addMoveAndCheckLoop();
    render();
    checkWin();
  }

  function pour(from, to){
    const amount = canPourAmount(from, to);
    if(amount <= 0){
      // if somehow called, still switch selection (UX rule)
      state.selected = to;
      render();
      return;
    }
    state.amounts[from] -= amount;
    state.amounts[to] += amount;
    addMoveAndCheckLoop();
    // after pour, select destination
    state.selected = to;
    render();
    checkWin();
  }

  function isGoalReached(){ return state.amounts.some(v => v === state.goal); }

  function computeNormalScore(moves, ms, minMoves){
    const base = 100;
    const extraMoves = Math.max(0, moves - (minMoves ?? moves));
    const movePenalty = extraMoves * 5;
    const baselineMs = (minMoves ?? moves) * 18 * 1000;
    const extraMs = Math.max(0, ms - baselineMs);
    const timePenalty = Math.floor(extraMs / (30*1000)) * 5;
    return Math.max(0, base - movePenalty - timePenalty);
  }

  function checkWin(){
    if(!isGoalReached()) return;
    endStage({type:"solve"});
  }

  // ---------- Results / Flow ----------
  function showModalCore(title, lines, buttons){
    const body = el("div");
    lines.forEach(t => {
      const p = el("p");
      p.innerHTML = t;
      body.appendChild(p);
    });
    showModal(title, body, buttons);
  }

  function endStage({type, hardImpossibleDeclared=false}){
    stopTimer();
    const elapsed = Date.now() - state.startMs;

    const record = {
      mode: state.mode,
      stageIndex: state.idx,
      caps: state.caps.slice(),
      goal: state.goal,
      moves: state.moves,
      timeMs: elapsed,
      timeText: msToMMSS(elapsed),
      resultType: type,
      declaredImpossible: hardImpossibleDeclared
    };

    if(state.mode === "normal"){
      const min = state.minMoves ?? bfsMinMoves(state.caps, state.goal);
      record.minMoves = min;
      record.score = computeNormalScore(state.moves, elapsed, min);
    }

    state.records.push(record);

    if(state.mode === "normal") showNormalStageClear(record);
    else showHardStageClear(record);
  }

  function showNormalStageClear(rec){
    const body = el("div");
    const kpi = el("div","kpi");
    const box1 = el("div","box");
    box1.innerHTML = `<div class="label">ì´ë²ˆ ìŠ¤í…Œì´ì§€ ì ìˆ˜</div><div class="val">${rec.score} / 100</div>`;
    const box2 = el("div","box");
    box2.innerHTML = `<div class="label">ì´ë™ íšŸìˆ˜</div><div class="val">${rec.moves}íšŒ</div>`;
    const box3 = el("div","box");
    box3.innerHTML = `<div class="label">í´ë¦¬ì–´ ì‹œê°„</div><div class="val">${rec.timeText}</div>`;
    kpi.append(box1,box2,box3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = "ì˜ í•´ê²°í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.";
    body.appendChild(p);

    const btnNext = el("button","good");
    btnNext.textContent = "ë‹¤ìŒ";
    btnNext.addEventListener("click", () => {
      closeModal();
      goNextNormalOrTier();
    });

    showModal("ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!", body, [btnNext]);
  }

  function showHardStageClear(rec){
    const body = el("div");
    const kpi = el("div","kpi");
    const box1 = el("div","box");
    box1.innerHTML = `<div class="label">ê²°ê³¼</div><div class="val">${rec.resultType === "declare-impossible" ? "ë¶ˆê°€ëŠ¥ íŒë‹¨" : "ëª©í‘œ ë‹¬ì„±"}</div>`;
    const box2 = el("div","box");
    box2.innerHTML = `<div class="label">ì´ë™ íšŸìˆ˜</div><div class="val">${rec.moves}íšŒ</div>`;
    const box3 = el("div","box");
    box3.innerHTML = `<div class="label">ì§„í–‰ ì‹œê°„</div><div class="val">${rec.timeText}</div>`;
    kpi.append(box1,box2,box3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = (rec.resultType === "declare-impossible")
      ? "ì´ ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œì˜€ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥´ê²Œ íŒë‹¨í–ˆìŠµë‹ˆë‹¤."
      : "ì´ ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ìˆëŠ” ë¬¸ì œì˜€ìŠµë‹ˆë‹¤. í•´ê²° ë°©ë²•ì„ ì˜ ì°¾ì•„ëƒˆìŠµë‹ˆë‹¤.";
    body.appendChild(p);

    const btnNext = el("button","good");
    btnNext.textContent = (state.idx === state.stages.length - 1) ? "ê²°ê³¼ ë³´ê¸°" : "ë‹¤ìŒ";
    btnNext.addEventListener("click", () => {
      closeModal();
      goNextHardOrEnd();
    });

    showModal("ì™„ë£Œ", body, [btnNext]);
  }

  function goNextNormalOrTier(){
    const stageNumber = state.idx + 1;
    const t = tiers.find(x => x.to === stageNumber);
    if(t){ showTierSummary(t); return; }
    if(state.idx < state.stages.length - 1){
      state.idx += 1;
      loadStage();
    }else{
      showFinalNormalSummary();
    }
  }

  function showTierSummary(tier){
    const fromIdx = tier.from - 1;
    const toIdx = tier.to - 1;
    const rows = state.records
      .filter(r => r.mode === "normal" && r.stageIndex >= fromIdx && r.stageIndex <= toIdx);

    const avg = Math.round(rows.reduce((a,b)=>a+(b.score??0),0) / rows.length);

    const body = el("div");
    const kpi = el("div","kpi");
    const b1 = el("div","box");
    b1.innerHTML = `<div class="label">${tier.name} ì ìˆ˜</div><div class="val">${avg} / 100</div>`;
    const b2 = el("div","box");
    b2.innerHTML = `<div class="label">${tier.name} ì´ ì´ë™</div><div class="val">${rows.reduce((a,b)=>a+b.moves,0)}íšŒ</div>`;
    const b3 = el("div","box");
    b3.innerHTML = `<div class="label">${tier.name} ì´ ì‹œê°„</div><div class="val">${msToMMSS(rows.reduce((a,b)=>a+b.timeMs,0))}</div>`;
    kpi.append(b1,b2,b3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = `${tier.name}ì—ì„œì˜ ê²°ê³¼ì…ë‹ˆë‹¤. ìŠ¤í…Œì´ì§€ë³„ ì´ë™ íšŸìˆ˜ì™€ ì‹œê°„ì„ í™•ì¸í•´ ë³´ì„¸ìš”.`;
    body.appendChild(p);

    const table = el("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>ìŠ¤í…Œì´ì§€</th>
          <th>ì´ë™ íšŸìˆ˜</th>
          <th>í´ë¦¬ì–´ ì‹œê°„</th>
          <th>ì ìˆ˜</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td>${r.stageIndex+1}</td>
            <td>${r.moves}íšŒ</td>
            <td>${r.timeText}</td>
            <td>${r.score} / 100</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    body.appendChild(table);

    const btnNext = el("button","good");
    btnNext.textContent = (tier.to === 20) ? "ìµœì¢… ê²°ê³¼ ë³´ê¸°" : "ë‹¤ìŒ ë‹¨ê³„ë¡œ";
    btnNext.addEventListener("click", () => {
      closeModal();
      if(tier.to === 20) showFinalNormalSummary();
      else { state.idx += 1; loadStage(); }
    });

    showModal(`${tier.name} ì™„ë£Œ!`, body, [btnNext]);
  }

  function showFinalNormalSummary(){
    const rows = state.records.filter(r => r.mode === "normal");
    const tierScores = tiers.map(t => {
      const subset = rows.filter(r => (r.stageIndex+1) >= t.from && (r.stageIndex+1) <= t.to);
      const avg = Math.round(subset.reduce((a,b)=>a+(b.score??0),0)/subset.length);
      return {name:t.name, avg, subset};
    });
    const overall = Math.round(tierScores.reduce((a,b)=>a+b.avg,0)/tierScores.length);

    const body = el("div");
    const kpi = el("div","kpi");
    const b1 = el("div","box"); b1.innerHTML = `<div class="label">ìµœì¢… ì ìˆ˜</div><div class="val">${overall} / 100</div>`;
    const b2 = el("div","box"); b2.innerHTML = `<div class="label">ì´ ì´ë™</div><div class="val">${rows.reduce((a,b)=>a+b.moves,0)}íšŒ</div>`;
    const b3 = el("div","box"); b3.innerHTML = `<div class="label">ì´ ì‹œê°„</div><div class="val">${msToMMSS(rows.reduce((a,b)=>a+b.timeMs,0))}</div>`;
    kpi.append(b1,b2,b3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = "ë‹¨ê³„ë³„ ì ìˆ˜ì™€ ìŠ¤í…Œì´ì§€ë³„ ê¸°ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
    body.appendChild(p);

    const table = el("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>ë‹¨ê³„</th>
          <th>ì ìˆ˜(í‰ê· )</th>
          <th>ìŠ¤í…Œì´ì§€</th>
        </tr>
      </thead>
      <tbody>
        ${tierScores.map(t => `
          <tr>
            <td>${t.name}</td>
            <td>${t.avg} / 100</td>
            <td>${t.subset[0].stageIndex+1}â€“${t.subset[t.subset.length-1].stageIndex+1}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    body.appendChild(table);

    const btnDetails = el("button","primary");
    btnDetails.textContent = "ì „ì²´ ìŠ¤í…Œì´ì§€ ê¸°ë¡ ë³´ê¸°";
    btnDetails.addEventListener("click", () => {
      closeModal();
      showAllNormalDetails();
    });

    const btnMenu = el("button","ghost");
    btnMenu.textContent = "ë©”ë‰´ë¡œ";
    btnMenu.addEventListener("click", () => {
      closeModal();
      resetToMenu();
    });

    showModal("Normal ìµœì¢… ê²°ê³¼", body, [btnDetails, btnMenu]);
  }

  function showAllNormalDetails(){
    const rows = state.records.filter(r => r.mode === "normal");
    const body = el("div");
    const p = el("p");
    p.textContent = "ìŠ¤í…Œì´ì§€ë³„ ì´ë™ íšŸìˆ˜ì™€ í´ë¦¬ì–´ ì‹œê°„, ì ìˆ˜ì…ë‹ˆë‹¤.";
    body.appendChild(p);

    const table = el("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>ìŠ¤í…Œì´ì§€</th>
          <th>í†µ(ìš©ëŸ‰)</th>
          <th>ëª©í‘œ</th>
          <th>ì´ë™</th>
          <th>ì‹œê°„</th>
          <th>ì ìˆ˜</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td>${r.stageIndex+1}</td>
            <td>${r.caps.join(", ")}L</td>
            <td>${r.goal}L</td>
            <td>${r.moves}íšŒ</td>
            <td>${r.timeText}</td>
            <td>${r.score} / 100</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    body.appendChild(table);

    const btnMenu = el("button","ghost");
    btnMenu.textContent = "ë©”ë‰´ë¡œ";
    btnMenu.addEventListener("click", () => {
      closeModal();
      resetToMenu();
    });

    showModal("ì „ì²´ ê¸°ë¡", body, [btnMenu]);
  }

  function goNextHardOrEnd(){
    if(state.idx < state.stages.length - 1){
      state.idx += 1;
      loadStage();
    }else{
      showHardEndSummary();
    }
  }

  function showHardEndSummary(){
    const rows = state.records.filter(r => r.mode === "hard");
    const solved = rows.filter(r => r.resultType === "solve").length;
    const judged = rows.filter(r => r.resultType === "declare-impossible").length;

    const body = el("div");
    const kpi = el("div","kpi");
    const b1 = el("div","box"); b1.innerHTML = `<div class="label">ëª©í‘œ ë‹¬ì„±</div><div class="val">${solved}ê°œ</div>`;
    const b2 = el("div","box"); b2.innerHTML = `<div class="label">ë¶ˆê°€ëŠ¥ íŒë‹¨</div><div class="val">${judged}ê°œ</div>`;
    const b3 = el("div","box"); b3.innerHTML = `<div class="label">ì´ ì‹œê°„</div><div class="val">${msToMMSS(rows.reduce((a,b)=>a+b.timeMs,0))}</div>`;
    kpi.append(b1,b2,b3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = "Hard ëª¨ë“œëŠ” ì •ë‹µì„ ë§Œë“œëŠ” ê²ƒë¿ ì•„ë‹ˆë¼, ê°€ëŠ¥í•œì§€ ë¶ˆê°€ëŠ¥í•œì§€ íŒë‹¨í•˜ëŠ” í˜ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.";
    body.appendChild(p);

    const table = el("table");
    table.innerHTML = `
      <thead>
        <tr>
          <th>ìŠ¤í…Œì´ì§€</th>
          <th>í†µ(ìš©ëŸ‰)</th>
          <th>ëª©í‘œ</th>
          <th>ê²°ê³¼</th>
          <th>ì´ë™</th>
          <th>ì‹œê°„</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td>${r.stageIndex+1}</td>
            <td>${r.caps.join(", ")}L</td>
            <td>${r.goal}L</td>
            <td>${r.resultType === "declare-impossible" ? "ë¶ˆê°€ëŠ¥ íŒë‹¨" : "ëª©í‘œ ë‹¬ì„±"}</td>
            <td>${r.moves}íšŒ</td>
            <td>${r.timeText}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    body.appendChild(table);

    const btnMenu = el("button","ghost");
    btnMenu.textContent = "ë©”ë‰´ë¡œ";
    btnMenu.addEventListener("click", () => {
      closeModal();
      resetToMenu();
    });

    showModal("Hard ê²°ê³¼", body, [btnMenu]);
  }

  function resetToMenu(){
    state.mode = null;
    state.stages = [];
    state.idx = 0;
    state.records = [];
    setScreen("start");
  }

  // ---------- Hard declare impossible ----------
  function parseTimeMMSS(mmss){
    const [mm, ss] = mmss.split(':').map(x => parseInt(x,10));
    if(Number.isFinite(mm) && Number.isFinite(ss)) return mm*60 + ss;
    return 0;
  }

  function openImpossibleQuiz(){
    if(!state.loopDetected) return;
    stopTimer();

    const body = el("div");
    const p = el("p");
    p.textContent = "ì´ ë¬¸ì œê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  ìƒê°í•œ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?";
    body.appendChild(p);

    const opts = [
      "ì•„ë¬´ë¦¬ í•´ë„ ë¬¼ì˜ ì–‘ì´ ê°™ì€ ë°©ì‹ìœ¼ë¡œë§Œ ë°”ë€Œì–´, ëª©í‘œí•œ ì–‘ì´ ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤.",
      "ë¬¼ì„ ì˜®ê¸°ëŠ” ìˆœì„œë¥¼ ì˜ëª» ì„ íƒí–ˆë‹¤.",
      "ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ë¿, ê³„ì†í•˜ë©´ ê°€ëŠ¥í•˜ë‹¤."
    ];

    const list = el("div");
    list.style.display = "grid";
    list.style.gap = "10px";
    let chosen = null;

    opts.forEach((text, idx) => {
      const b = el("button", idx===0 ? "primary" : "");
      b.textContent = text;
      b.style.textAlign = "left";
      b.addEventListener("click", () => chosen = idx);
      list.appendChild(b);
    });

    body.appendChild(list);

    const btnOk = el("button","good");
    btnOk.textContent = "íŒì •í•˜ê¸°";
    btnOk.addEventListener("click", () => {
      const solvableMin = bfsMinMoves(state.caps, state.goal);
      const actuallyImpossible = (solvableMin === null);

      if(chosen == null){
        const warn = el("div","banner warn");
        warn.textContent = "ì„ íƒì§€ë¥¼ í•˜ë‚˜ ê³¨ë¼ ì£¼ì„¸ìš”.";
        body.appendChild(warn);
        return;
      }

      if(actuallyImpossible && chosen === 0){
        closeModal();
        endStage({type:"declare-impossible", hardImpossibleDeclared:true});
      }else{
        closeModal();
        // resume timer approximately
        state.startMs = Date.now() - (parseTimeMMSS(timeText.textContent)*1000);
        startTimer();

        const tmp = el("div");
        const b = el("div","banner bad");
        b.textContent = "íŒì •ì´ ë§ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì† ì‹œë„í•´ ë³´ì„¸ìš”.";
        tmp.appendChild(b);

        const btnContinue = el("button","good");
        btnContinue.textContent = "ê³„ì†í•˜ê¸°";
        btnContinue.addEventListener("click", () => closeModal());
        showModal("íŒì • ì‹¤íŒ¨", tmp, [btnContinue]);
      }
    });

    const btnCancel = el("button","ghost");
    btnCancel.textContent = "ì·¨ì†Œ";
    btnCancel.addEventListener("click", () => {
      closeModal();
      state.startMs = Date.now() - (parseTimeMMSS(timeText.textContent)*1000);
      startTimer();
    });

    showModal("ë¶ˆê°€ëŠ¥ íŒë‹¨", body, [btnOk, btnCancel]);
  }

  // ---------- Stage loading ----------
  function loadStage(){
    const st = state.stages[state.idx];
    state.caps = st.caps.slice();
    state.goal = st.goal;

    if(state.mode === "normal"){
      state.minMoves = bfsMinMoves(state.caps, state.goal);
      if(state.minMoves === null) state.minMoves = null;
    }else{
      state.minMoves = null;
    }
    resetStageState();
  }

  // ---------- Events ----------
  $("#btnStartNormal").addEventListener("click", () => {
    state.mode = "normal";
    state.stages = normalStages.slice();
    state.idx = 0;
    state.records = [];
    setScreen("game");
    loadStage();
  });

  $("#btnStartHard").addEventListener("click", () => {
    state.mode = "hard";
    state.stages = hardStages.slice();
    state.idx = 0;
    state.records = [];
    setScreen("game");
    loadStage();
  });

  $("#btnBackToMenu").addEventListener("click", () => {
    const body = el("div");
    const p = el("p");
    p.textContent = "ë©”ë‰´ë¡œ ëŒì•„ê°€ë©´ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê¸°ë¡ì€ ì¢…ë£Œë©ë‹ˆë‹¤.";
    body.appendChild(p);

    const btnYes = el("button","bad");
    btnYes.textContent = "ë©”ë‰´ë¡œ";
    btnYes.addEventListener("click", () => {
      closeModal();
      resetToMenu();
    });

    const btnNo = el("button","good");
    btnNo.textContent = "ê³„ì†í•˜ê¸°";
    btnNo.addEventListener("click", () => closeModal());

    showModal("í™•ì¸", body, [btnNo, btnYes]);
  });

  $("#btnReset").addEventListener("click", () => {
    const body = el("div");
    const p = el("p");
    p.textContent = "ì´ ìŠ¤í…Œì´ì§€ë¥¼ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”?";
    body.appendChild(p);

    const btnYes = el("button","warn");
    btnYes.textContent = "ë¦¬ì…‹";
    btnYes.addEventListener("click", () => {
      closeModal();
      resetStageState();
    });

    const btnNo = el("button","ghost");
    btnNo.textContent = "ì·¨ì†Œ";
    btnNo.addEventListener("click", () => closeModal());

    showModal("ìŠ¤í…Œì´ì§€ ë¦¬ì…‹", body, [btnNo, btnYes]);
  });

  $("#btnFill").addEventListener("click", fillSelected);
  $("#btnEmpty").addEventListener("click", emptySelected);

  btnHint.addEventListener("click", () => {
    state.hintUsed += 1;
    const idx = Math.min(hintLevels.length, state.hintUsed) - 1;
    hintBox.textContent = hintLevels[idx] || hintLevels[hintLevels.length-1];
    if(state.hintUsed >= hintLevels.length) btnHint.disabled = true;
  });

  btnDeclareImpossible.addEventListener("click", () => {
    if(state.mode !== "hard") return;
    if(!state.loopDetected) return;
    openImpossibleQuiz();
  });

  // init
  setScreen("start");
})();
</script>
</body>
</html>
