<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¬¼í†µ ë¯¸ì…˜: ì •í™•í•œ ë¬¼ì˜ ì–‘ ë§Œë“¤ê¸°</title>
<style>
  :root{
    --bg:#0b1220;
    --ink:#e7eefc;
    --muted:#b8c7f3;
    --line:rgba(255,255,255,.12);
    --accent:#6ee7ff;
    --good:#22c55e;
    --warn:#fbbf24;
    --bad:#fb7185;

    /* Jug visuals */
    --cup-stroke: rgba(255,255,255,.22);
    --tick: rgba(255,255,255,.28);
    --tickText: rgba(231,238,252,.75);
    --waterTop: rgba(110,231,255,.85);
    --waterBottom: rgba(110,231,255,.28);
    --waterEdge: rgba(255,255,255,.22);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
    background: radial-gradient(1200px 600px at 20% 10%, rgba(110,231,255,.10), transparent 55%),
                radial-gradient(900px 500px at 80% 15%, rgba(34,197,94,.08), transparent 55%),
                radial-gradient(1000px 600px at 50% 95%, rgba(251,113,133,.10), transparent 60%),
                var(--bg);
    color:var(--ink);
    min-height:100vh;
  }
  .wrap{max-width:980px;margin:0 auto;padding:22px}
  .card{
    background: linear-gradient(180deg, rgba(16,26,46,.92), rgba(12,20,40,.92));
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow: 0 18px 40px rgba(0,0,0,.35);
    overflow:hidden;
  }
  .topbar{
    display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-bottom:1px solid var(--line);
  }
  .title{display:flex;flex-direction:column;gap:2px}
  .title h1{margin:0;font-size:18px;letter-spacing:.2px}
  .title p{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    padding:8px 10px;border-radius:999px;
    font-size:12px;color:var(--muted);
  }
  .pill strong{color:var(--ink);font-weight:700}

  .grid{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:14px;
    padding:14px;
  }
  @media (max-width: 860px){
    .grid{grid-template-columns:1fr}
  }

  .panel{
    background: rgba(255,255,255,.03);
    border:1px solid var(--line);
    border-radius:16px;
    padding:14px;
  }
  .panel h2{
    margin:0 0 10px 0;
    font-size:14px;color:var(--muted);
    font-weight:700;
    letter-spacing:.2px;
  }
  .btnrow{display:flex;flex-wrap:wrap;gap:10px}
  button{
    appearance:none;border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:var(--ink);
    padding:10px 12px;border-radius:12px;
    cursor:pointer;
    font-weight:700;
    transition:.15s transform ease, .15s background ease, .15s border-color ease, .15s opacity ease;
  }
  button:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
  button:active{transform: translateY(0px)}
  button.primary{
    border-color: rgba(110,231,255,.35);
    background: rgba(110,231,255,.10);
  }
  button.good{
    border-color: rgba(34,197,94,.35);
    background: rgba(34,197,94,.10);
  }
  button.warn{
    border-color: rgba(251,191,36,.38);
    background: rgba(251,191,36,.10);
  }
  button.bad{
    border-color: rgba(251,113,133,.38);
    background: rgba(251,113,133,.10);
  }
  button.ghost{background: transparent;}
  button:disabled{opacity:.45; cursor:not-allowed;}

  /* Toggle button state */
  button.toggleOn{
    border-color: rgba(110,231,255,.55);
    background: rgba(110,231,255,.14);
    box-shadow: 0 0 0 3px rgba(110,231,255,.10);
  }

  /* Jugs layout */
  .jugs{
    display:flex; gap:12px; justify-content:center; align-items:flex-end;
    padding:10px 6px 6px 6px;
    min-height:320px;
  }
  .jug{
    width:150px; max-width:34vw;
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:16px;
    padding:10px;
    position:relative;
    user-select:none;
    cursor:pointer;
    transition: .15s transform ease, .15s border-color ease, .15s background ease;
  }
  .jug:hover{transform: translateY(-2px); background: rgba(255,255,255,.05)}
  .jug.selected{
    border-color: rgba(110,231,255,.55);
    box-shadow: 0 0 0 3px rgba(110,231,255,.15);
  }
  .jug .cap{
    display:flex; align-items:center; justify-content:space-between;
    font-size:12px; color:var(--muted); margin-bottom:8px;
  }
  .jug .cap strong{color:var(--ink); font-size:12px}

  .jugSvgWrap{
    width:100%;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    border-radius:12px;
    background: rgba(0,0,0,.10);
    border:1px solid rgba(255,255,255,.08);
    overflow:hidden;
    height:230px; /* JSì—ì„œ ìš©ëŸ‰ì— ë”°ë¼ ì¡°ì • */
  }
  .jugSvgWrap svg{display:block; width:100%; height:100%}

  /* Water animation: waterGroup transform transitions */
  .waterGroup{
    transition: transform .38s ease;
    will-change: transform;
  }
  /* wave subtle movement */
  @keyframes waveDrift {
    0%   { transform: translateX(0px); }
    50%  { transform: translateX(2px); }
    100% { transform: translateX(0px); }
  }
  .waveWiggle{
    animation: waveDrift 4.2s ease-in-out infinite;
    transform-origin: center;
  }

  .amt{
    margin-top:8px;
    display:flex; justify-content:space-between; align-items:center;
    font-size:12px; color:var(--muted);
  }
  .amt strong{color:var(--ink)}

  .status{
    display:flex;flex-wrap:wrap; gap:8px;
    font-size:12px; color:var(--muted);
  }
  .status .tag{
    border:1px solid var(--line);
    padding:6px 10px;border-radius:999px;
    background: rgba(255,255,255,.03);
  }
  .status .tag strong{color:var(--ink)}
  .banner{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.04);
    color:var(--muted);
    font-size:13px; line-height:1.45;
  }
  .banner.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.08)}
  .banner.bad{border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08)}
  .row{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
  }
  .hintbox{
    margin-top:10px;
    border:1px dashed rgba(110,231,255,.28);
    background: rgba(110,231,255,.06);
    padding:10px 12px;border-radius:12px;
    color:var(--muted);
    font-size:13px; line-height:1.45;
    min-height:46px;
  }
  .tiny{font-size:12px;color:var(--muted);line-height:1.45}
  .divider{height:1px;background:var(--line);margin:14px 0}

  /* Modal */
  .modalOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.55);
    display:none;
    align-items:center; justify-content:center;
    padding:18px;
    z-index:50;
  }
  .modal{
    width:min(920px, 100%);
    background: linear-gradient(180deg, rgba(16,26,46,.96), rgba(12,20,40,.96));
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow: 0 22px 60px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .modalHeader{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;
  }
  .modalHeader h3{margin:0;font-size:14px}
  .modalBody{padding:14px 16px}
  .modalBody p{margin:0 0 10px 0; color:var(--muted); line-height:1.55; font-size:13px}
  table{
    width:100%;
    border-collapse:collapse;
    overflow:hidden;
    border-radius:14px;
    border:1px solid var(--line);
  }
  th, td{
    padding:10px 10px;
    border-bottom:1px solid var(--line);
    font-size:13px;
    text-align:left;
  }
  th{color:var(--muted); background: rgba(255,255,255,.03)}
  tr:last-child td{border-bottom:none}
  .kpi{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-bottom:12px;
  }
  @media (max-width: 720px){
    .kpi{grid-template-columns:1fr}
  }
  .kpi .box{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:14px;
    padding:10px 12px;
  }
  .kpi .box .label{font-size:12px;color:var(--muted)}
  .kpi .box .val{font-size:18px;font-weight:900;margin-top:4px}
  .footerRow{
    display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
    padding:12px 16px;
    border-top:1px solid var(--line);
  }

  .start{padding:18px;}
  .modeCard{
    border:1px solid var(--line);
    background: rgba(255,255,255,.03);
    border-radius:16px;
    padding:14px;
  }
  .modeCard h3{margin:0 0 6px 0;font-size:15px}
  .modeCard p{margin:0;color:var(--muted);font-size:13px;line-height:1.55}
  .modeCard .btnrow{margin-top:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- Start Screen -->
    <div id="startScreen">
      <div class="topbar">
        <div class="title">
          <h1>ë¬¼í†µ ë¯¸ì…˜ : ì •í™•í•œ ë¬¼ì˜ ì–‘ì„ ë§Œë“¤ì–´ë¼</h1>
          <p>ë¬¼ì„ ì˜®ê²¨ ëª©í‘œí•œ ì–‘ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</p>
        </div>
        <div class="pill"><strong>ë²„ì „</strong> v1.3 (ì„ íƒí•´ì œ+ë°”ë‹¥ì •ë ¬+ë°°ê²½í´ë¦­ì·¨ì†Œ+DEVí•«í‚¤)</div>
      </div>

      <div class="start">
        <div class="grid" style="padding:0">
          <div class="modeCard">
            <h3>ğŸŸ¢ Normal ëª¨ë“œ</h3>
            <p>
              ë¬¼í†µì„ ì˜®ê²¨ì„œ <strong>ì •í™•í•œ ë¬¼ì˜ ì–‘ì„ ë§Œë“œëŠ” ì—°ìŠµ ëª¨ë“œ</strong>ì…ë‹ˆë‹¤.<br/>
              íŒíŠ¸ê°€ ìˆìœ¼ë©°, <strong>ì ì€ ì´ë™ìœ¼ë¡œ í•´ê²°í• ìˆ˜ë¡ ë†’ì€ ì ìˆ˜(100ì  ë§Œì )</strong>ë¥¼ ì–»ìŠµë‹ˆë‹¤.
            </p>
            <div class="btnrow">
              <button class="primary" id="btnStartNormal">Normal ì‹œì‘í•˜ê¸°</button>
            </div>
            <div class="divider"></div>
            <div class="tiny">
              â€¢ ëª¨ë“  ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
              â€¢ ì´ˆê¸‰ â†’ ì¤‘ê¸‰ â†’ ê³ ê¸‰ ìˆœì„œë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
            </div>
          </div>

          <div class="modeCard">
            <h3>ğŸ”´ Hard ëª¨ë“œ</h3>
            <p>
              ì´ ëª¨ë“œì—ëŠ” <strong>í•´ê²°í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œë„ í¬í•¨</strong>ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br/>
              ëê¹Œì§€ ì‹œë„í•˜ë©´ì„œ <strong>ì´ ë¬¸ì œëŠ” ê°€ëŠ¥í•œì§€, ë¶ˆê°€ëŠ¥í•œì§€ íŒë‹¨</strong>í•´ì•¼ í•©ë‹ˆë‹¤.
            </p>
            <div class="banner warn" style="margin-top:10px">
              âš ï¸ ì–´ë–¤ ë¬¸ì œëŠ” <strong>ì •ë‹µì„ ë§Œë“œëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  íŒë‹¨í•˜ëŠ” ê²ƒì´ ì •ë‹µ</strong>ì…ë‹ˆë‹¤.
            </div>
            <div class="btnrow" style="margin-top:12px">
              <button class="bad" id="btnStartHard">Hard ë„ì „í•˜ê¸°</button>
            </div>
            <div class="divider"></div>
            <div class="tiny">
              â€¢ íŒíŠ¸ëŠ” ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>
              â€¢ ì ìˆ˜ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (íŒë‹¨ ì¤‘ì‹¬)
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="tiny">
          ì´ ê²Œì„ì€ <strong>ì •ë‹µë¿ë§Œ ì•„ë‹ˆë¼ ìƒê°í•˜ëŠ” ê³¼ì •</strong>ì„ ì¤‘ìš”í•˜ê²Œ ë´…ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" style="display:none">
      <div class="topbar">
        <div class="title">
          <h1 id="modeTitle">Normal</h1>
          <p id="stageDesc">ì„¤ëª…</p>
        </div>
        <div class="status">
          <div class="tag">ìŠ¤í…Œì´ì§€ <strong id="stageNo">1</strong></div>
          <div class="tag">ëª©í‘œ <strong id="goalText">4L</strong></div>
          <div class="tag">ì´ë™ <strong id="movesText">0</strong></div>
          <div class="tag">ì‹œê°„ <strong id="timeText">00:00</strong></div>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT PANEL (ë°°ê²½ í´ë¦­ìœ¼ë¡œ ì„ íƒ ì·¨ì†Œ ì ìš© ì˜ì—­) -->
        <div class="panel" id="jugPanel">
          <h2>ë¬¼í†µ</h2>
          <div class="banner" id="instructionBanner">
            í†µì„ ëˆ„ë¥´ë©´ ì„ íƒë©ë‹ˆë‹¤. ë¬¼ì„ ì˜®ê¸¸ ë•ŒëŠ” <strong>ì˜®ê¸°ê¸° ëª¨ë“œ</strong>ë¥¼ ì¼  ë’¤, ë‹¤ë¥¸ í†µì„ ëˆ„ë¥´ì„¸ìš”.<br/>
            ë¬¼ì„ ì˜®ê¸°ë©´ <strong>ì„ íƒì´ ìë™ìœ¼ë¡œ ì·¨ì†Œ</strong>ë©ë‹ˆë‹¤.
          </div>

          <div class="jugs" id="jugs"></div>

          <div class="row">
            <div class="tiny" id="selectInfo">ì„ íƒ: ì—†ìŒ</div>
            <div class="btnrow">
              <button id="btnReset" class="ghost">ìŠ¤í…Œì´ì§€ ë¦¬ì…‹</button>
              <button id="btnBackToMenu" class="ghost">ë©”ë‰´</button>
            </div>
          </div>

          <div class="banner warn" id="loopBanner" style="display:none;margin-top:10px">
            ì „ì— ë´¤ë˜ ë¬¼ ìƒíƒœê°€ ë‹¤ì‹œ ë‚˜íƒ€ë‚¬ì–´ìš”. ìƒˆë¡œìš´ ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>

        <div class="panel">
          <h2>ì¡°ì‘</h2>
          <div class="btnrow">
            <button id="btnFill" class="primary">ì±„ìš°ê¸°</button>
            <button id="btnEmpty">ë¹„ìš°ê¸°</button>
            <button id="btnPourMode" class="">ì˜®ê¸°ê¸° ëª¨ë“œ: êº¼ì§</button>
            <button id="btnDeclareImpossible" class="bad" style="display:none" disabled>ì´ ë¬¸ì œëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  íŒë‹¨í•˜ê¸°</button>
          </div>

          <div class="banner" id="modeBanner" style="margin-top:12px">
            í˜„ì¬ ëª¨ë“œ: <strong id="modeStateText">ì„ íƒ</strong>
          </div>

          <div id="normalHintArea" style="margin-top:12px; display:none">
            <div class="row">
              <h2 style="margin:0;color:var(--muted);font-size:14px">íŒíŠ¸</h2>
              <button id="btnHint" class="warn">íŒíŠ¸ ë³´ê¸°</button>
            </div>
            <div class="hintbox" id="hintBox">íŒíŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          </div>

          <div id="hardNoteArea" style="margin-top:12px; display:none">
            <div class="banner">
              ì´ ëª¨ë“œì—ëŠ” í’€ ìˆ˜ ì—†ëŠ” ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëê¹Œì§€ ì‹œë„í•˜ë©° íŒë‹¨í•´ ë³´ì„¸ìš”.
            </div>
          </div>

          <div class="divider"></div>
          <div class="tiny">
            â€¢ ì´ë™ì€ <strong>ì±„ìš°ê¸° / ë¹„ìš°ê¸° / ì˜®ê¸°ê¸°</strong> ëª¨ë‘ 1íšŒë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.<br/>
            â€¢ í†µì˜ í¬ê¸°ëŠ” ìš©ëŸ‰ì— ë”°ë¼ ì¡°ê¸ˆì”© ë‹¤ë¦…ë‹ˆë‹¤.<br/>
            â€¢ (ê°œë°œì) ìˆ«ì 1 ì™¼ìª½ í‚¤(â‚©/`/~/\) + â†/â†’/Enter
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal -->
<div class="modalOverlay" id="modalOverlay">
  <div class="modal">
    <div class="modalHeader">
      <h3 id="modalTitle">ê²°ê³¼</h3>
      <button class="ghost" id="btnCloseModal">ë‹«ê¸°</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="footerRow" id="modalFooter"></div>
  </div>
</div>

<script>
(() => {
  // ---------- Utility ----------
  const $ = (sel) => document.querySelector(sel);
  const pad2 = (n) => String(n).padStart(2,'0');
  const msToMMSS = (ms) => {
    const s = Math.max(0, Math.floor(ms/1000));
    const mm = Math.floor(s/60);
    const ss = s%60;
    return `${pad2(mm)}:${pad2(ss)}`;
  };

  // ---------- BFS (min moves) ----------
  function bfsMinMoves(capacities, goal){
    const n = capacities.length;
    const start = Array(n).fill(0);
    const key = (st) => st.join(',');
    const q = [{st:start, d:0}];
    const seen = new Set([key(start)]);
    const isGoal = (st) => st.some(v => v === goal);
    if (isGoal(start)) return 0;

    while(q.length){
      const {st, d} = q.shift();
      for(let i=0;i<n;i++){
        if(st[i] !== capacities[i]){
          const ns = st.slice(); ns[i] = capacities[i];
          const k = key(ns);
          if(!seen.has(k)){
            if(isGoal(ns)) return d+1;
            seen.add(k); q.push({st:ns,d:d+1});
          }
        }
        if(st[i] !== 0){
          const ns = st.slice(); ns[i] = 0;
          const k = key(ns);
          if(!seen.has(k)){
            if(isGoal(ns)) return d+1;
            seen.add(k); q.push({st:ns,d:d+1});
          }
        }
        if(st[i] !== 0){
          for(let j=0;j<n;j++){
            if(i===j) continue;
            if(st[j] === capacities[j]) continue;
            const amount = Math.min(st[i], capacities[j]-st[j]);
            if(amount<=0) continue;
            const ns = st.slice();
            ns[i] -= amount;
            ns[j] += amount;
            const k = key(ns);
            if(!seen.has(k)){
              if(isGoal(ns)) return d+1;
              seen.add(k); q.push({st:ns,d:d+1});
            }
          }
        }
      }
    }
    return null;
  }

  // ---------- BFS (path for animation) ----------
  function bfsPath(capacities, goal){
    const n = capacities.length;
    const start = Array(n).fill(0);
    const key = (st) => st.join(',');
    const isGoal = (st) => st.some(v => v === goal);

    const q = [start];
    const parent = new Map(); // key -> {prevKey, st}
    parent.set(key(start), {prev:null, st:start});

    while(q.length){
      const st = q.shift();
      if(isGoal(st)){
        // reconstruct path of states
        const path = [];
        let k = key(st);
        while(k){
          const node = parent.get(k);
          path.push(node.st);
          k = node.prev;
        }
        path.reverse();
        return path;
      }

      for(let i=0;i<n;i++){
        // fill i
        if(st[i] !== capacities[i]){
          const ns = st.slice(); ns[i] = capacities[i];
          const nk = key(ns);
          if(!parent.has(nk)){
            parent.set(nk, {prev:key(st), st:ns});
            q.push(ns);
          }
        }
        // empty i
        if(st[i] !== 0){
          const ns = st.slice(); ns[i] = 0;
          const nk = key(ns);
          if(!parent.has(nk)){
            parent.set(nk, {prev:key(st), st:ns});
            q.push(ns);
          }
        }
        // pour i -> j
        if(st[i] !== 0){
          for(let j=0;j<n;j++){
            if(i===j) continue;
            if(st[j] === capacities[j]) continue;
            const amount = Math.min(st[i], capacities[j]-st[j]);
            if(amount<=0) continue;
            const ns = st.slice();
            ns[i] -= amount;
            ns[j] += amount;
            const nk = key(ns);
            if(!parent.has(nk)){
              parent.set(nk, {prev:key(st), st:ns});
              q.push(ns);
            }
          }
        }
      }
    }
    return null;
  }

  // ---------- Stages ----------
  const normalStages = [
    {caps:[3,5], goal:4},
    {caps:[2,7], goal:5},
    {caps:[4,7], goal:3},
    {caps:[5,8], goal:6},
    {caps:[6,10], goal:2},
    {caps:[3,8], goal:7},

    {caps:[4,9], goal:1},
    {caps:[5,9], goal:7},
    {caps:[6,11], goal:5},
    {caps:[7,11], goal:6},
    {caps:[3,5,8], goal:4},
    {caps:[3,7,10], goal:6},
    {caps:[4,7,9], goal:5},

    {caps:[5,8,13], goal:6},
    {caps:[3,6,11], goal:8},
    {caps:[3,7,11], goal:5},
    {caps:[4,9,13], goal:10},
    {caps:[5,7,12], goal:6},
    {caps:[3,8,14], goal:11},
    {caps:[3,7,15], goal:9},
  ];

  const hardStages = [
    {caps:[3,5], goal:4},
    {caps:[2,9], goal:7},
    {caps:[5,8], goal:6},
    {caps:[4,7], goal:5},
    {caps:[3,7,11], goal:5},
    {caps:[6,11], goal:1},

    {caps:[6,10], goal:5},
    {caps:[4,8], goal:6},
    {caps:[3,9], goal:4},
    {caps:[5,15], goal:4},
  ];

  const tiers = [
    {name:"ì´ˆê¸‰", from:1, to:6},
    {name:"ì¤‘ê¸‰", from:7, to:13},
    {name:"ê³ ê¸‰", from:14, to:20},
  ];

  const hintLevels = [
    "í•œ ë²ˆì— í•´ê²°í•˜ë ¤ê³  í•˜ì§€ ë§ê³ , ë¨¼ì € â€˜ì¤‘ê°„ ìƒíƒœâ€™ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.",
    "ì‘ì€ í†µì„ â€˜ì¸¡ì • ë„êµ¬â€™ì²˜ëŸ¼ ì¨ ë³´ì„¸ìš”. ê°€ë“ ì±„ìš°ê³  ì˜®ê¸°ë©´ ë‚¨ëŠ” ì–‘ì´ ìƒê¹ë‹ˆë‹¤.",
    "ê°™ì€ í–‰ë™ì„ ë°˜ë³µí•˜ë‹¤ê°€, ì´ì „ê³¼ ë˜‘ê°™ì€ ìƒí™©ì´ ë‹¤ì‹œ ë‚˜ì˜¤ë©´ ë‹¤ë¥¸ ì„ íƒì„ ì‹œë„í•´ ë³´ì„¸ìš”."
  ];

  // ---------- State ----------
  const state = {
    mode: null,
    stages: [],
    idx: 0,
    caps: [],
    goal: 0,
    amounts: [],
    selected: null,
    moves: 0,
    startMs: 0,
    timerId: null,
    loopSet: new Set(),
    loopDetected: false,
    minMoves: null,
    hintUsed: 0,
    records: [],
    pourMode: false,
    jugUI: [],
    isAutoSolving: false
  };

  // ---------- DOM ----------
  const startScreen = $("#startScreen");
  const gameScreen = $("#gameScreen");
  const modeTitle = $("#modeTitle");
  const stageDesc = $("#stageDesc");
  const stageNo = $("#stageNo");
  const goalText = $("#goalText");
  const movesText = $("#movesText");
  const timeText = $("#timeText");
  const jugsEl = $("#jugs");
  const selectInfo = $("#selectInfo");
  const loopBanner = $("#loopBanner");
  const btnDeclareImpossible = $("#btnDeclareImpossible");

  const normalHintArea = $("#normalHintArea");
  const hardNoteArea = $("#hardNoteArea");
  const hintBox = $("#hintBox");
  const btnHint = $("#btnHint");

  const btnPourMode = $("#btnPourMode");
  const modeStateText = $("#modeStateText");

  const jugPanel = $("#jugPanel");

  const modalOverlay = $("#modalOverlay");
  const modalTitle = $("#modalTitle");
  const modalBody = $("#modalBody");
  const modalFooter = $("#modalFooter");

  // ---------- Modal helpers ----------
  function el(tag, cls){
    const n = document.createElement(tag);
    if(cls) n.className = cls;
    return n;
  }
  function showModal(title, bodyNode, footerButtons){
    modalTitle.textContent = title;
    modalBody.innerHTML = "";
    modalBody.appendChild(bodyNode);
    modalFooter.innerHTML = "";
    footerButtons.forEach(b => modalFooter.appendChild(b));
    modalOverlay.style.display = "flex";
  }
  function closeModal(){ modalOverlay.style.display = "none"; }
  $("#btnCloseModal").addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => { if(e.target === modalOverlay) closeModal(); });

  function setScreen(which){
    if(which === "start"){
      startScreen.style.display = "";
      gameScreen.style.display = "none";
      stopTimer();
    }else{
      startScreen.style.display = "none";
      gameScreen.style.display = "";
    }
  }

  // ---------- Timer ----------
  function stopTimer(){
    if(state.timerId){
      clearInterval(state.timerId);
      state.timerId = null;
    }
  }
  function startTimer(){
    stopTimer();
    state.timerId = setInterval(() => {
      const ms = Date.now() - state.startMs;
      timeText.textContent = msToMMSS(ms);
    }, 250);
    timeText.textContent = "00:00";
  }

  // ---------- SVG jug template + refs ----------
  function createJugElement(jugIndex, cap){
    const W = 120, H = 210;
    const innerX = 22, innerY = 22, innerW = 76, innerH = 160;

    const tickSideX = innerX + innerW + 6;
    const tick0Y = innerY + innerH;
    const tickMidY = innerY + innerH/2;
    const tickMaxY = innerY;

    const jugCard = el("div","jug");
    jugCard.setAttribute("role","button");
    jugCard.setAttribute("tabindex","0");

    const head = el("div","cap");
    head.innerHTML = `<span>${jugIndex+1}ë²ˆ í†µ</span><strong>${cap}L</strong>`;

    const svgWrap = el("div","jugSvgWrap");

    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
    svg.setAttribute("width","100%");
    svg.setAttribute("height","100%");
    // âœ… B ë°˜ì˜: ì»¨í…Œì´ë„ˆê°€ ì»¤ì ¸ë„ ì•„ë˜ ê¸°ì¤€ìœ¼ë¡œ ë¶™ë„ë¡(ë–  ë³´ì„ ê°œì„ )
    svg.setAttribute("preserveAspectRatio", "xMidYMax meet");

    const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
    const id = `s${state.idx}_j${jugIndex}_${Math.random().toString(16).slice(2)}`;

    const cupGrad = document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
    cupGrad.setAttribute("id", `cupGrad-${id}`);
    cupGrad.setAttribute("x1","0"); cupGrad.setAttribute("y1","0");
    cupGrad.setAttribute("x2","1"); cupGrad.setAttribute("y2","0");
    cupGrad.innerHTML = `
      <stop offset="0" stop-color="rgba(255,255,255,.08)"/>
      <stop offset="0.35" stop-color="rgba(255,255,255,.03)"/>
      <stop offset="0.7" stop-color="rgba(255,255,255,.07)"/>
      <stop offset="1" stop-color="rgba(255,255,255,.04)"/>
    `;

    const waterGrad = document.createElementNS("http://www.w3.org/2000/svg","linearGradient");
    waterGrad.setAttribute("id", `waterGrad-${id}`);
    waterGrad.setAttribute("x1","0"); waterGrad.setAttribute("y1","0");
    waterGrad.setAttribute("x2","0"); waterGrad.setAttribute("y2","1");
    waterGrad.innerHTML = `
      <stop offset="0" stop-color="var(--waterTop)"/>
      <stop offset="1" stop-color="var(--waterBottom)"/>
    `;

    const clip = document.createElementNS("http://www.w3.org/2000/svg","clipPath");
    clip.setAttribute("id", `cupClip-${id}`);
    const innerRect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    innerRect.setAttribute("x", innerX);
    innerRect.setAttribute("y", innerY);
    innerRect.setAttribute("width", innerW);
    innerRect.setAttribute("height", innerH);
    innerRect.setAttribute("rx","10");
    clip.appendChild(innerRect);

    defs.appendChild(cupGrad);
    defs.appendChild(waterGrad);
    defs.appendChild(clip);
    svg.appendChild(defs);

    const baseShadow = document.createElementNS("http://www.w3.org/2000/svg","ellipse");
    baseShadow.setAttribute("cx", W/2);
    baseShadow.setAttribute("cy", H-10);
    baseShadow.setAttribute("rx","36");
    baseShadow.setAttribute("ry","8");
    baseShadow.setAttribute("fill","rgba(0,0,0,.25)");
    svg.appendChild(baseShadow);

    const cupG = document.createElementNS("http://www.w3.org/2000/svg","g");

    const outer = document.createElementNS("http://www.w3.org/2000/svg","path");
    outer.setAttribute("d",
      "M 18 20 Q 18 10 28 10 L 92 10 Q 102 10 102 20 L 106 184 Q 106 198 92 198 L 28 198 Q 14 198 14 184 Z"
    );
    outer.setAttribute("fill", `url(#cupGrad-${id})`);
    outer.setAttribute("stroke", "var(--cup-stroke)");
    outer.setAttribute("stroke-width","1.2");
    cupG.appendChild(outer);

    const rim = document.createElementNS("http://www.w3.org/2000/svg","path");
    rim.setAttribute("d",
      "M 26 10 L 94 10 Q 102 10 102 18 L 102 22 Q 102 14 94 14 L 26 14 Q 18 14 18 22 L 18 18 Q 18 10 26 10 Z"
    );
    rim.setAttribute("fill","rgba(255,255,255,.10)");
    rim.setAttribute("stroke","rgba(255,255,255,.18)");
    rim.setAttribute("stroke-width",".6");
    cupG.appendChild(rim);

    const base = document.createElementNS("http://www.w3.org/2000/svg","rect");
    base.setAttribute("x","18"); base.setAttribute("y","186");
    base.setAttribute("width","88"); base.setAttribute("height","14");
    base.setAttribute("rx","10");
    base.setAttribute("fill","rgba(255,255,255,.07)");
    base.setAttribute("stroke","rgba(255,255,255,.12)");
    base.setAttribute("stroke-width",".6");
    cupG.appendChild(base);

    const wall = document.createElementNS("http://www.w3.org/2000/svg","rect");
    wall.setAttribute("x", innerX);
    wall.setAttribute("y", innerY);
    wall.setAttribute("width", innerW);
    wall.setAttribute("height", innerH);
    wall.setAttribute("rx","10");
    wall.setAttribute("fill","rgba(0,0,0,.18)");
    wall.setAttribute("stroke","rgba(255,255,255,.10)");
    wall.setAttribute("stroke-width",".6");
    cupG.appendChild(wall);

    const hi = document.createElementNS("http://www.w3.org/2000/svg","rect");
    hi.setAttribute("x","28"); hi.setAttribute("y","22");
    hi.setAttribute("width","10"); hi.setAttribute("height","164");
    hi.setAttribute("rx","6");
    hi.setAttribute("fill","rgba(255,255,255,.07)");
    cupG.appendChild(hi);

    svg.appendChild(cupG);

    const waterClipG = document.createElementNS("http://www.w3.org/2000/svg","g");
    waterClipG.setAttribute("clip-path", `url(#cupClip-${id})`);

    const waterGroup = document.createElementNS("http://www.w3.org/2000/svg","g");
    waterGroup.classList.add("waterGroup");

    const waterRect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    waterRect.setAttribute("x", innerX);
    waterRect.setAttribute("y", innerY);
    waterRect.setAttribute("width", innerW);
    waterRect.setAttribute("height", innerH);
    waterRect.setAttribute("fill", `url(#waterGrad-${id})`);
    waterGroup.appendChild(waterRect);

    const waveGroup = document.createElementNS("http://www.w3.org/2000/svg","g");
    waveGroup.classList.add("waveWiggle");

    const wavePath = document.createElementNS("http://www.w3.org/2000/svg","path");
    wavePath.setAttribute("fill","none");
    wavePath.setAttribute("stroke","var(--waterEdge)");
    wavePath.setAttribute("stroke-width","1");
    wavePath.setAttribute("opacity",".65");
    waveGroup.appendChild(wavePath);

    waterClipG.appendChild(waterGroup);
    waterClipG.appendChild(waveGroup);
    svg.appendChild(waterClipG);

    const tickG = document.createElementNS("http://www.w3.org/2000/svg","g");
    tickG.setAttribute("opacity",".95");

    function tickLine(y, len){
      const ln = document.createElementNS("http://www.w3.org/2000/svg","line");
      ln.setAttribute("x1", tickSideX);
      ln.setAttribute("y1", y);
      ln.setAttribute("x2", tickSideX + len);
      ln.setAttribute("y2", y);
      ln.setAttribute("stroke","var(--tick)");
      ln.setAttribute("stroke-width","1");
      return ln;
    }
    tickG.appendChild(tickLine(tickMaxY, 10));
    tickG.appendChild(tickLine(tickMidY, 8));
    tickG.appendChild(tickLine(tick0Y, 10));

    function tickText(y, text){
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", tickSideX + 12);
      t.setAttribute("y", y + 4);
      t.setAttribute("font-size","10");
      t.setAttribute("fill","var(--tickText)");
      t.textContent = text;
      return t;
    }
    tickG.appendChild(tickText(tickMaxY, String(cap)));
    tickG.appendChild(tickText(tickMidY, String(Math.round(cap/2))));
    tickG.appendChild(tickText(tick0Y, "0"));
    svg.appendChild(tickG);

    svgWrap.appendChild(svg);

    const amt = el("div","amt");
    const amtLeft = el("span"); amtLeft.textContent = "í˜„ì¬";
    const amtStrong = el("strong"); amtStrong.textContent = "0L";
    amt.appendChild(amtLeft);
    amt.appendChild(amtStrong);

    jugCard.appendChild(head);
    jugCard.appendChild(svgWrap);
    jugCard.appendChild(amt);

    jugCard.addEventListener("click", (e) => {
      if(state.isAutoSolving) return;
      onJugClick(jugIndex);
    });
    jugCard.addEventListener("keydown", (e) => {
      if(state.isAutoSolving) return;
      if(e.key === "Enter" || e.key === " ") { e.preventDefault(); onJugClick(jugIndex); }
    });

    return {
      jugCard,
      svgWrap,
      amtStrong,
      waterGroup,
      wavePath,
      waveGroup,
      geom: { innerX, innerY, innerW, innerH },
    };
  }

  function setWavePath(refs, waterTopY){
    const { innerX, innerW } = refs.geom;
    const amp = 2.2;
    const x0 = innerX, x1 = innerX + innerW;
    const c1 = innerX + innerW*0.25;
    const c2 = innerX + innerW*0.45;
    const c3 = innerX + innerW*0.60;
    const c4 = innerX + innerW*0.75;
    const c5 = innerX + innerW*0.88;

    const d = `M ${x0} ${waterTopY}
      C ${c1} ${waterTopY-amp}, ${c2} ${waterTopY+amp}, ${c3} ${waterTopY}
      C ${c4} ${waterTopY-amp}, ${c5} ${waterTopY+amp}, ${x1} ${waterTopY}`;
    refs.wavePath.setAttribute("d", d);
    refs.waveGroup.setAttribute("transform", `translate(0,0)`);
  }

  function updateWaterVisual(jugIndex){
    const cap = state.caps[jugIndex];
    const amt = state.amounts[jugIndex];
    const refs = state.jugUI[jugIndex];

    refs.amtStrong.textContent = `${amt}L`;

    const { innerY, innerH } = refs.geom;
    const waterH = (amt / cap) * innerH;
    const offset = innerH - waterH;
    refs.waterGroup.style.transform = `translate(0px, ${offset}px)`;

    const waterTopY = innerY + offset;
    setWavePath(refs, waterTopY);
  }

  // ---------- Capacity-proportional jug size ----------
  function applyJugSizing(){
    const caps = state.caps.slice();
    const minC = Math.min(...caps);
    const maxC = Math.max(...caps);

    const base = 230;
    const minScale = 0.80;
    const maxScale = 1.38;

    for(let i=0;i<caps.length;i++){
      let t = 0;
      if(maxC !== minC) t = (caps[i] - minC) / (maxC - minC);
      const scale = minScale + (maxScale - minScale) * t;
      const h = Math.round(base * scale);
      state.jugUI[i].svgWrap.style.height = `${h}px`;
    }
  }

  // ---------- Stage state ----------
  function resetStageState(){
    state.amounts = Array(state.caps.length).fill(0);
    state.selected = null;
    state.moves = 0;
    state.hintUsed = 0;
    state.loopSet = new Set();
    state.loopDetected = false;
    loopBanner.style.display = "none";

    state.pourMode = false;
    updatePourModeUI();

    btnDeclareImpossible.disabled = true;
    btnDeclareImpossible.style.display = (state.mode === "hard") ? "" : "none";

    state.loopSet.add(state.amounts.join(','));
    hintBox.textContent = "íŒíŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";
    btnHint.disabled = false;

    state.startMs = Date.now();
    startTimer();

    buildJugUI();
    renderTopUI();
    renderModeSections();
  }

  function renderTopUI(){
    modeTitle.textContent = state.mode === "normal" ? "Normal" : "Hard";
    stageNo.textContent = String(state.idx + 1);
    goalText.textContent = `${state.goal}L`;
    movesText.textContent = String(state.moves);
    selectInfo.textContent = state.selected == null
      ? "ì„ íƒ: ì—†ìŒ"
      : `ì„ íƒ: ${state.selected+1}ë²ˆ í†µ (${state.caps[state.selected]}L)`;

    if(state.mode === "hard"){
      loopBanner.style.display = state.loopDetected ? "" : "none";
      btnDeclareImpossible.disabled = !state.loopDetected;
    }else{
      loopBanner.style.display = "none";
    }
  }

  function renderModeSections(){
    if(state.mode === "normal"){
      stageDesc.textContent = "ëª©í‘œí•œ ë¬¼ì˜ ì–‘ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”. ì´ë™ íšŸìˆ˜ë¥¼ ì¤„ì¼ìˆ˜ë¡ ì ìˆ˜ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤.";
      normalHintArea.style.display = "";
      hardNoteArea.style.display = "none";
      btnDeclareImpossible.style.display = "none";
    }else{
      stageDesc.textContent = "ì´ ë¬¸ì œëŠ” ê°€ëŠ¥í•  ìˆ˜ë„, ë¶ˆê°€ëŠ¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ëê¹Œì§€ ì‹œë„í•˜ë©° íŒë‹¨í•´ ë³´ì„¸ìš”.";
      normalHintArea.style.display = "none";
      hardNoteArea.style.display = "";
      btnDeclareImpossible.style.display = "";
    }
  }

  function buildJugUI(){
    state.jugUI = [];
    jugsEl.innerHTML = "";
    state.caps.forEach((cap, i) => {
      const refs = createJugElement(i, cap);
      state.jugUI.push(refs);
      jugsEl.appendChild(refs.jugCard);
    });

    applyJugSizing();

    for(let i=0;i<state.caps.length;i++){
      updateWaterVisual(i);
      state.jugUI[i].jugCard.classList.toggle("selected", state.selected === i);
    }
  }

  function updateSelectionUI(){
    for(let i=0;i<state.jugUI.length;i++){
      state.jugUI[i].jugCard.classList.toggle("selected", state.selected === i);
    }
    selectInfo.textContent = state.selected == null
      ? "ì„ íƒ: ì—†ìŒ"
      : `ì„ íƒ: ${state.selected+1}ë²ˆ í†µ (${state.caps[state.selected]}L)`;
  }

  function cancelSelection(){
    if(state.selected == null) return;
    state.selected = null;
    updateSelectionUI();
  }

  function updatePourModeUI(){
    modeStateText.textContent = state.pourMode ? "ì˜®ê¸°ê¸°" : "ì„ íƒ";
    btnPourMode.textContent = `ì˜®ê¸°ê¸° ëª¨ë“œ: ${state.pourMode ? "ì¼œì§" : "êº¼ì§"}`;
    btnPourMode.classList.toggle("toggleOn", state.pourMode);
  }

  // ---------- Game logic ----------
  function addMoveAndCheckLoop(){
    state.moves += 1;
    movesText.textContent = String(state.moves);

    const key = state.amounts.join(',');
    if(state.loopSet.has(key)){
      state.loopDetected = true;
    }else{
      state.loopSet.add(key);
    }

    if(state.mode === "hard"){
      loopBanner.style.display = state.loopDetected ? "" : "none";
      btnDeclareImpossible.disabled = !state.loopDetected;
    }
  }

  function canPourAmount(from, to){
    const capTo = state.caps[to];
    if(state.amounts[from] <= 0) return 0;
    if(state.amounts[to] >= capTo) return 0;
    return Math.min(state.amounts[from], capTo - state.amounts[to]);
  }

  function onJugClick(i){
    if(state.selected == null){
      state.selected = i;
      updateSelectionUI();
      return;
    }

    if(state.selected === i){
      updateSelectionUI();
      return;
    }

    if(!state.pourMode){
      state.selected = i;
      updateSelectionUI();
      return;
    }

    const from = state.selected;
    const to = i;
    const amount = canPourAmount(from, to);

    if(amount > 0){
      state.amounts[from] -= amount;
      state.amounts[to] += amount;
      addMoveAndCheckLoop();

      // âœ… A ë°˜ì˜: ì˜®ê¸°ê¸° ì„±ê³µ í›„ ì„ íƒ ìë™ ì·¨ì†Œ
      state.selected = null;
      updateSelectionUI();

      updateWaterVisual(from);
      updateWaterVisual(to);

      checkWin();
    }else{
      state.selected = to;
      updateSelectionUI();
    }
  }

  function fillSelected(){
    if(state.selected == null) return;
    const i = state.selected;
    if(state.amounts[i] === state.caps[i]) return;

    state.amounts[i] = state.caps[i];
    addMoveAndCheckLoop();
    updateWaterVisual(i);
    checkWin();
  }

  function emptySelected(){
    if(state.selected == null) return;
    const i = state.selected;
    if(state.amounts[i] === 0) return;

    state.amounts[i] = 0;
    addMoveAndCheckLoop();
    updateWaterVisual(i);
    checkWin();
  }

  function isGoalReached(){
    return state.amounts.some(v => v === state.goal);
  }

  function computeNormalScore(moves, ms, minMoves){
    const base = 100;
    const extraMoves = Math.max(0, moves - (minMoves ?? moves));
    const movePenalty = extraMoves * 5;
    const baselineMs = (minMoves ?? moves) * 18 * 1000;
    const extraMs = Math.max(0, ms - baselineMs);
    const timePenalty = Math.floor(extraMs / (30*1000)) * 5;
    return Math.max(0, base - movePenalty - timePenalty);
  }

  // ---------- Results / Flow ----------
  function endStage({type, hardImpossibleDeclared=false}){
    stopTimer();
    const elapsed = Date.now() - state.startMs;

    const record = {
      mode: state.mode,
      stageIndex: state.idx,
      caps: state.caps.slice(),
      goal: state.goal,
      moves: state.moves,
      timeMs: elapsed,
      timeText: msToMMSS(elapsed),
      resultType: type,
      declaredImpossible: hardImpossibleDeclared
    };

    if(state.mode === "normal"){
      const min = state.minMoves ?? bfsMinMoves(state.caps, state.goal);
      record.minMoves = min;
      record.score = computeNormalScore(state.moves, elapsed, min);
    }

    state.records.push(record);

    if(state.mode === "normal") showNormalStageClear(record);
    else showHardStageClear(record);
  }

  function showNormalStageClear(rec){
    const body = el("div");
    const kpi = el("div","kpi");
    const box1 = el("div","box");
    box1.innerHTML = `<div class="label">ì´ë²ˆ ìŠ¤í…Œì´ì§€ ì ìˆ˜</div><div class="val">${rec.score} / 100</div>`;
    const box2 = el("div","box");
    box2.innerHTML = `<div class="label">ì´ë™ íšŸìˆ˜</div><div class="val">${rec.moves}íšŒ</div>`;
    const box3 = el("div","box");
    box3.innerHTML = `<div class="label">í´ë¦¬ì–´ ì‹œê°„</div><div class="val">${rec.timeText}</div>`;
    kpi.append(box1,box2,box3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = "ì˜ í•´ê²°í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.";
    body.appendChild(p);

    const btnNext = el("button","good");
    btnNext.textContent = "ë‹¤ìŒ";
    btnNext.addEventListener("click", () => { closeModal(); goNextNormalOrTier(); });

    showModal("ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!", body, [btnNext]);
  }

  function showHardStageClear(rec){
    const body = el("div");
    const kpi = el("div","kpi");
    const box1 = el("div","box");
    box1.innerHTML = `<div class="label">ê²°ê³¼</div><div class="val">${rec.resultType === "declare-impossible" ? "ë¶ˆê°€ëŠ¥ íŒë‹¨" : "ëª©í‘œ ë‹¬ì„±"}</div>`;
    const box2 = el("div","box");
    box2.innerHTML = `<div class="label">ì´ë™ íšŸìˆ˜</div><div class="val">${rec.moves}íšŒ</div>`;
    const box3 = el("div","box");
    box3.innerHTML = `<div class="label">ì§„í–‰ ì‹œê°„</div><div class="val">${rec.timeText}</div>`;
    kpi.append(box1,box2,box3);
    body.appendChild(kpi);

    const p = el("p");
    p.textContent = (rec.resultType === "declare-impossible")
      ? "ì´ ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œì˜€ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥´ê²Œ íŒë‹¨í–ˆìŠµë‹ˆë‹¤."
      : "ì´ ë¬¸ì œëŠ” í•´ê²°í•  ìˆ˜ ìˆëŠ” ë¬¸ì œì˜€ìŠµë‹ˆë‹¤. í•´ê²° ë°©ë²•ì„ ì˜ ì°¾ì•„ëƒˆìŠµë‹ˆë‹¤.";
    body.appendChild(p);

    const btnNext = el("button","good");
    btnNext.textContent = (state.idx === state.stages.length - 1) ? "ê²°ê³¼ ë³´ê¸°" : "ë‹¤ìŒ";
    btnNext.addEventListener("click", () => { closeModal(); goNextHardOrEnd(); });

    showModal("ì™„ë£Œ", body, [btnNext]);
  }

  function goNextNormalOrTier(){
    const stageNumber = state.idx + 1;
    const t = tiers.find(x => x.to === stageNumber);
    if(t){ showTierSummary(t); return; }
    if(state.idx < state.stages.length - 1){
      state.idx += 1;
      loadStage();
    }else{
      showFinalNormalSummary();
    }
  }

  function showTierSummary(tier){
    const fromIdx = tier.from - 1;
    const toIdx = tier.to - 1;
    const rows = state.records
      .filter(r => r.mode === "normal" && r.stageIndex >= fromIdx && r.stageIndex <= toIdx);

    const avg = Math.round(rows.reduce((a,b)=>a+(b.score??0),0) / rows.length);

    const body = el("div");
    const p = el("p");
    p.textContent = `${tier.name}ì—ì„œì˜ ê²°ê³¼ì…ë‹ˆë‹¤. ìŠ¤í…Œì´ì§€ë³„ ì´ë™ íšŸìˆ˜ì™€ ì‹œê°„ì„ í™•ì¸í•´ ë³´ì„¸ìš”.`;
    body.appendChild(p);

    const table = el("table");
    table.innerHTML = `
      <thead>
        <tr><th>ìŠ¤í…Œì´ì§€</th><th>ì´ë™ íšŸìˆ˜</th><th>í´ë¦¬ì–´ ì‹œê°„</th><th>ì ìˆ˜</th></tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td>${r.stageIndex+1}</td>
            <td>${r.moves}íšŒ</td>
            <td>${r.timeText}</td>
            <td>${r.score} / 100</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    body.appendChild(table);

    const btnNext = el("button","good");
    btnNext.textContent = (tier.to === 20) ? "ìµœì¢… ê²°ê³¼ ë³´ê¸°" : "ë‹¤ìŒ ë‹¨ê³„ë¡œ";
    btnNext.addEventListener("click", () => {
      closeModal();
      if(tier.to === 20) showFinalNormalSummary();
      else { state.idx += 1; loadStage(); }
    });

    showModal(`${tier.name} ì™„ë£Œ!`, body, [btnNext]);
  }

  function showFinalNormalSummary(){
    const rows = state.records.filter(r => r.mode === "normal");
    const tierScores = tiers.map(t => {
      const subset = rows.filter(r => (r.stageIndex+1) >= t.from && (r.stageIndex+1) <= t.to);
      const avg = Math.round(subset.reduce((a,b)=>a+(b.score??0),0)/subset.length);
      return {name:t.name, avg, subset};
    });
    const overall = Math.round(tierScores.reduce((a,b)=>a+b.avg,0)/tierScores.length);

    const body = el("div");
    const p = el("p");
    p.textContent = `ìµœì¢… ì ìˆ˜: ${overall} / 100`;
    body.appendChild(p);

    const btnMenu = el("button","ghost");
    btnMenu.textContent = "ë©”ë‰´ë¡œ";
    btnMenu.addEventListener("click", () => { closeModal(); resetToMenu(); });

    showModal("Normal ìµœì¢… ê²°ê³¼", body, [btnMenu]);
  }

  function goNextHardOrEnd(){
    if(state.idx < state.stages.length - 1){
      state.idx += 1;
      loadStage();
    }else{
      showHardEndSummary();
    }
  }

  function showHardEndSummary(){
    const rows = state.records.filter(r => r.mode === "hard");
    const solved = rows.filter(r => r.resultType === "solve").length;
    const judged = rows.filter(r => r.resultType === "declare-impossible").length;

    const body = el("div");
    const p = el("p");
    p.textContent = `ëª©í‘œ ë‹¬ì„± ${solved}ê°œ / ë¶ˆê°€ëŠ¥ íŒë‹¨ ${judged}ê°œ`;
    body.appendChild(p);

    const btnMenu = el("button","ghost");
    btnMenu.textContent = "ë©”ë‰´ë¡œ";
    btnMenu.addEventListener("click", () => { closeModal(); resetToMenu(); });

    showModal("Hard ê²°ê³¼", body, [btnMenu]);
  }

  // ---------- Hard declare impossible ----------
  function parseTimeMMSS(mmss){
    const [mm, ss] = mmss.split(':').map(x => parseInt(x,10));
    if(Number.isFinite(mm) && Number.isFinite(ss)) return mm*60 + ss;
    return 0;
  }

  function openImpossibleQuiz(){
    if(!state.loopDetected) return;
    stopTimer();

    const body = el("div");
    body.appendChild(Object.assign(el("p"), {textContent:"ì´ ë¬¸ì œê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤ê³  ìƒê°í•œ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?"}));

    const opts = [
      "ì•„ë¬´ë¦¬ í•´ë„ ë¬¼ì˜ ì–‘ì´ ê°™ì€ ë°©ì‹ìœ¼ë¡œë§Œ ë°”ë€Œì–´, ëª©í‘œí•œ ì–‘ì´ ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤.",
      "ë¬¼ì„ ì˜®ê¸°ëŠ” ìˆœì„œë¥¼ ì˜ëª» ì„ íƒí–ˆë‹¤.",
      "ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ë¿, ê³„ì†í•˜ë©´ ê°€ëŠ¥í•˜ë‹¤."
    ];

    const list = el("div");
    list.style.display = "grid";
    list.style.gap = "10px";
    let chosen = null;

    opts.forEach((text, idx) => {
      const b = el("button", idx===0 ? "primary" : "");
      b.textContent = text;
      b.style.textAlign = "left";
      b.addEventListener("click", () => chosen = idx);
      list.appendChild(b);
    });

    body.appendChild(list);

    const btnOk = el("button","good");
    btnOk.textContent = "íŒì •í•˜ê¸°";
    btnOk.addEventListener("click", () => {
      const solvableMin = bfsMinMoves(state.caps, state.goal);
      const actuallyImpossible = (solvableMin === null);

      if(chosen == null){
        const warn = el("div","banner warn");
        warn.textContent = "ì„ íƒì§€ë¥¼ í•˜ë‚˜ ê³¨ë¼ ì£¼ì„¸ìš”.";
        body.appendChild(warn);
        return;
      }

      if(actuallyImpossible && chosen === 0){
        closeModal();
        endStage({type:"declare-impossible", hardImpossibleDeclared:true});
      }else{
        closeModal();
        state.startMs = Date.now() - (parseTimeMMSS(timeText.textContent)*1000);
        startTimer();

        const tmp = el("div");
        const b = el("div","banner bad");
        b.textContent = "íŒì •ì´ ë§ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³„ì† ì‹œë„í•´ ë³´ì„¸ìš”.";
        tmp.appendChild(b);

        const btnContinue = el("button","good");
        btnContinue.textContent = "ê³„ì†í•˜ê¸°";
        btnContinue.addEventListener("click", () => closeModal());
        showModal("íŒì • ì‹¤íŒ¨", tmp, [btnContinue]);
      }
    });

    const btnCancel = el("button","ghost");
    btnCancel.textContent = "ì·¨ì†Œ";
    btnCancel.addEventListener("click", () => {
      closeModal();
      state.startMs = Date.now() - (parseTimeMMSS(timeText.textContent)*1000);
      startTimer();
    });

    showModal("ë¶ˆê°€ëŠ¥ íŒë‹¨", body, [btnOk, btnCancel]);
  }

  // ---------- Win ----------
  function checkWin(){
    if(!isGoalReached()) return;
    endStage({type:"solve"});
  }

  // ---------- Stage loading ----------
  function loadStage(){
    const st = state.stages[state.idx];
    state.caps = st.caps.slice();
    state.goal = st.goal;

    if(state.mode === "normal"){
      state.minMoves = bfsMinMoves(state.caps, state.goal);
      if(state.minMoves === null) state.minMoves = null;
    }else{
      state.minMoves = null;
    }
    resetStageState();
  }

  function resetToMenu(){
    state.mode = null;
    state.stages = [];
    state.idx = 0;
    state.records = [];
    setScreen("start");
  }

  // ---------- NEW: ë°°ê²½ í´ë¦­ìœ¼ë¡œ ì„ íƒ ì·¨ì†Œ ----------
  jugPanel.addEventListener("click", (e) => {
    if(state.isAutoSolving) return;
    // ë¬¼í†µ(.jug) í´ë¦­ì€ ì œì™¸
    if(e.target.closest(".jug")) return;
    // ë²„íŠ¼/ì…ë ¥ ìš”ì†Œ í´ë¦­ì€ ì œì™¸(ì›ì¹˜ ì•ŠëŠ” ì·¨ì†Œ ë°©ì§€)
    if(e.target.closest("button")) return;
    // ê·¸ ì™¸ íŒ¨ë„ ë¹ˆ ê³µê°„ í´ë¦­ì´ë©´ ì„ íƒ ì·¨ì†Œ
    cancelSelection();
  });

  // ---------- DEV HOTKEYS ----------
  const DEV_KEYS = new Set(["â‚©","`","~","\\"]);
  let devHeld = false;

  function isDevKeyEvent(e){
    // í‚¤ë³´ë“œë§ˆë‹¤ e.keyê°€ ë‹¤ë¥´ê²Œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆì–´ codeë„ í•¨ê»˜ ì²´í¬
    if(e.code === "Backquote") return true; // ìˆ«ì 1 ì™¼ìª½ í‚¤(ëŒ€ë¶€ë¶„)
    return DEV_KEYS.has(e.key);
  }

  function devMoveStage(delta){
    if(gameScreen.style.display === "none") return; // ê²Œì„ ì¤‘ì¼ ë•Œë§Œ
    if(state.isAutoSolving) return;
    const next = Math.max(0, Math.min(state.stages.length - 1, state.idx + delta));
    if(next === state.idx) return;
    state.idx = next;
    loadStage();
  }

  function devForceClear(){
    if(gameScreen.style.display === "none") return;
    if(state.isAutoSolving) return;

    const path = bfsPath(state.caps, state.goal);
    if(!path){
      const body = el("div");
      body.appendChild(Object.assign(el("p"), {textContent:"ì´ ìŠ¤í…Œì´ì§€ëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œë¼ì„œ ìë™ í´ë¦¬ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}));
      const btn = el("button","ghost"); btn.textContent="ë‹«ê¸°";
      btn.addEventListener("click", closeModal);
      showModal("ìë™ í´ë¦¬ì–´ ë¶ˆê°€", body, [btn]);
      return;
    }

    // ìë™ í’€ì´ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    state.isAutoSolving = true;
    cancelSelection();
    state.pourMode = false;
    updatePourModeUI();

    // ì´ë™/ì‹œê°„ì€ 'ë³´ì—¬ì£¼ê¸°'ê°€ ëª©ì ì´ë¯€ë¡œ, ì´ë™ íšŸìˆ˜ëŠ” path ê¸°ë°˜ìœ¼ë¡œ ê°±ì‹ (ê°œë°œììš©)
    // (ì›í•˜ë©´ ì—¬ê¸°ì„œ moves ëˆ„ì  ëŒ€ì‹  ë³„ë„ í‘œê¸°ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆìŒ)
    const startMoves = state.moves;
    const startTimeMs = Date.now() - state.startMs;

    let step = 0;
    const interval = 450;

    const tick = () => {
      if(step >= path.length){
        // ë: ê¸°ë¡ìƒ ê¹”ë”í•˜ê²Œ ë§ì¶”ê¸°
        state.isAutoSolving = false;
        // ê°œë°œì í´ë¦¬ì–´ëŠ” "ìµœì†Œ ê²½ë¡œ ê¸¸ì´-1" ì •ë„ë¡œ ë§ì¶¤
        state.moves = (path.length - 1);
        movesText.textContent = String(state.moves);
        endStage({type:"solve"});
        return;
      }

      state.amounts = path[step].slice();
      // ì‹œê° ì—…ë°ì´íŠ¸
      for(let i=0;i<state.caps.length;i++) updateWaterVisual(i);

      // ë£¨í”„ ì²´í¬/í‘œì‹œëŠ” ìƒëµ(ê°œë°œììš©)
      step += 1;
      setTimeout(tick, interval);
    };

    tick();
  }

  document.addEventListener("keydown", (e) => {
    // ëª¨ë‹¬ì´ ë–  ìˆìœ¼ë©´ í‚¤ ì…ë ¥ìœ¼ë¡œ ìŠ¤í…Œì´ì§€ ì´ë™/í´ë¦¬ì–´ê°€ íŠ€ì§€ ì•Šê²Œ ë§‰ìŒ(ê°œë°œììš© ì•ˆì •)
    if(modalOverlay.style.display === "flex") return;

    if(isDevKeyEvent(e)){
      devHeld = true;
      return;
    }
    if(!devHeld) return;

    if(e.key === "ArrowLeft"){
      e.preventDefault();
      devMoveStage(-1);
    }else if(e.key === "ArrowRight"){
      e.preventDefault();
      devMoveStage(+1);
    }else if(e.key === "Enter"){
      e.preventDefault();
      devForceClear();
    }
  });

  document.addEventListener("keyup", (e) => {
    if(isDevKeyEvent(e)){
      devHeld = false;
    }
  });

  // ---------- Events ----------
  $("#btnStartNormal").addEventListener("click", () => {
    state.mode = "normal";
    state.stages = normalStages.slice();
    state.idx = 0;
    state.records = [];
    setScreen("game");
    loadStage();
  });

  $("#btnStartHard").addEventListener("click", () => {
    state.mode = "hard";
    state.stages = hardStages.slice();
    state.idx = 0;
    state.records = [];
    setScreen("game");
    loadStage();
  });

  $("#btnBackToMenu").addEventListener("click", () => {
    const body = el("div");
    body.appendChild(Object.assign(el("p"), {textContent:"ë©”ë‰´ë¡œ ëŒì•„ê°€ë©´ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ê¸°ë¡ì€ ì¢…ë£Œë©ë‹ˆë‹¤."}));

    const btnYes = el("button","bad");
    btnYes.textContent = "ë©”ë‰´ë¡œ";
    btnYes.addEventListener("click", () => { closeModal(); resetToMenu(); });

    const btnNo = el("button","good");
    btnNo.textContent = "ê³„ì†í•˜ê¸°";
    btnNo.addEventListener("click", () => closeModal());

    showModal("í™•ì¸", body, [btnNo, btnYes]);
  });

  $("#btnReset").addEventListener("click", () => {
    const body = el("div");
    body.appendChild(Object.assign(el("p"), {textContent:"ì´ ìŠ¤í…Œì´ì§€ë¥¼ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”?"}));

    const btnYes = el("button","warn");
    btnYes.textContent = "ë¦¬ì…‹";
    btnYes.addEventListener("click", () => { closeModal(); resetStageState(); });

    const btnNo = el("button","ghost");
    btnNo.textContent = "ì·¨ì†Œ";
    btnNo.addEventListener("click", () => closeModal());

    showModal("ìŠ¤í…Œì´ì§€ ë¦¬ì…‹", body, [btnNo, btnYes]);
  });

  $("#btnFill").addEventListener("click", () => { if(!state.isAutoSolving){ fillSelected(); renderTopUI(); }});
  $("#btnEmpty").addEventListener("click", () => { if(!state.isAutoSolving){ emptySelected(); renderTopUI(); }});

  btnPourMode.addEventListener("click", () => {
    if(state.isAutoSolving) return;
    state.pourMode = !state.pourMode;
    updatePourModeUI();
  });

  btnHint.addEventListener("click", () => {
    state.hintUsed += 1;
    const idx = Math.min(hintLevels.length, state.hintUsed) - 1;
    hintBox.textContent = hintLevels[idx] || hintLevels[hintLevels.length-1];
    if(state.hintUsed >= hintLevels.length) btnHint.disabled = true;
  });

  btnDeclareImpossible.addEventListener("click", () => {
    if(state.mode !== "hard") return;
    if(!state.loopDetected) return;
    openImpossibleQuiz();
  });

  // initial
  setScreen("start");
})();
</script>
</body>
</html>
